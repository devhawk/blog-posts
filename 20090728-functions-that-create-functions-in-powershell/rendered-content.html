<p>Since I started using Powershell, I’m very picky about what I let on my
path. I feel it’s much cleaner to create aliases or functions rather
than letting all kinds of crud creep into my path.</p>
<p>Recently, I installed the latest <a href="http://www.ironruby.com/Download">IronRuby
release</a> and discovered there’s a
whole bunch of little batch file wrappers around common Ruby commands
like gem and rake. While being able to simply type “igem” or “irake” is
much easier than typing <code>ir &quot;C:\Program Files\ironruby-0.6.0\bin\igem&quot;</code>, I
didn’t want to pollute my path – even with a product from my team.
Instead, I wanted to create a Powershell function for each of those
IronRuby-fied commands. Furthermore, I wanted to avoid manually creating
a function for each Ruby command – these batchfiles are literally
identical except for their name, so I figured it would be possible
automate the function creation in Powershell. Here’s what I came up
with:</p>
<div class="lang-powershell editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:OrangeRed;">$iralias</span> <span style="color:Gray;">=</span> get<span style="color:Gray;">-</span>alias ir <span style="color:Gray;">-</span>EA SilentlyContinue
<span style="color:Blue;">if</span> (<span style="color:OrangeRed;">$iralias</span> <span style="color:Gray;">-eq</span> <span style="color:OrangeRed;">$null</span>) {<span style="color:Blue;">return</span>}

<span style="color:OrangeRed;">$irbindir</span> <span style="color:Gray;">=</span> split<span style="color:Gray;">-</span>path <span style="color:OrangeRed;">$iralias</span>.Definition

<span style="color:Blue;">function</span> make<span style="color:Gray;">-</span>rubyfunction(<span style="color:OrangeRed;">$cmd</span>)
{
  <span style="color:OrangeRed;">$cmdpath</span> <span style="color:Gray;">=</span> join<span style="color:Gray;">-</span>path <span style="color:OrangeRed;">$irbindir</span> <span style="color:OrangeRed;">$cmd</span>
  set<span style="color:Gray;">-</span>item <span style="color:Blue;">function</span>:global:<span style="color:OrangeRed;">$cmd</span> <span style="color:Gray;">-</span>Value {ir <span style="color:OrangeRed;">$cmdpath</span> <span style="color:OrangeRed;">$args</span>}.GetNewClosure()
  write<span style="color:Gray;">-</span>host <span style="color:#A31515;">&quot;Added IronRuby $_ command&quot;</span>
}

(<span style="color:#A31515;">&quot;igem&quot;</span>,<span style="color:#A31515;">&quot;iirb&quot;</span>,<span style="color:#A31515;">&quot;irackup&quot;</span>,<span style="color:#A31515;">&quot;irails&quot;</span>,<span style="color:#A31515;">&quot;irake&quot;</span>,<span style="color:#A31515;">&quot;irdoc&quot;</span>,<span style="color:#A31515;">&quot;iri&quot;</span>) |
  <span style="color:Gray;">%</span>{make<span style="color:Gray;">-</span>rubyfunction <span style="color:OrangeRed;">$_</span>}

</pre></div>
</div>
<p>I start by getting the ir alias, which I’m <a href="http://devhawk.net/2008/12/17/powershell-find-to-set-alias/">setting in my traditional
fashion</a>.
The Ruby command files are in the same directory as ir.exe, which is
what ir is aliased to. If the ir alias isn’t set, I quit out of the
script without setting anything.</p>
<p>The make-rubyfunction function is the primary workhorse of this script.
You pass in a command name as a string, and it uses
<a href="http://technet.microsoft.com/en-us/library/dd347590.aspx">set-item</a> on
the <a href="http://technet.microsoft.com/en-us/library/dd347741.aspx">function
provider</a> to
create a new function. Note, I had to explicitly create this function in
the global scope since I’m running the set-item cmdlet inside a script.</p>
<p>Getting the value for the function took a bit of head banging to figure
out. I’m used to Python, which automatically closes over variables, so
my first attempt was to set the function value to something like { ir
$cmdpath $args }. But Powershell doesn’t close automatically, so that
fails since $cmd isn’t defined inside the function. I asked around on
the internal Powershell alias, and someone pointed me to the new
<a href="http://blogs.msdn.com/powershell/archive/2009/03/27/get-closure-with-getnewclosure.aspx">GetNewClosure</a>
function in Powershell v2. In other words, Powershell only supports
manual closures, which is kind of wonky, but works OK for this scenario.
I create a new script block that references in-scope variable $cmdpath
and GetNewClosure automatically creates a new script block where that
value is captured and embedded. More info on GetNewClosure <a href="http://msdn.microsoft.com/en-us/library/system.management.automation.scriptblock.getnewclosure(VS.85).aspx">in the
docs</a>.</p>
<p>Now, I’m using Win7 exclusively at this point, so depending on a v2
feature didn’t bother me. However, if you’re using Powershell v1, you
could still accomplish something similar using text substitution. Here’s
my original (i.e. pre-GetNewClosure) version of make-rubyfunction</p>
<div class="lang-powershell editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">function</span> make<span style="color:Gray;">-</span>rubyfunction(<span style="color:OrangeRed;">$cmd</span>)
{
  <span style="color:OrangeRed;">$cmdpath</span> <span style="color:Gray;">=</span> join<span style="color:Gray;">-</span>path <span style="color:OrangeRed;">$irbindir</span> <span style="color:OrangeRed;">$cmd</span>
  <span style="color:OrangeRed;">$p</span> <span style="color:Gray;">=</span> <span style="color:#A31515;">&quot;ir `&quot;$cmdpath`&quot; `$args&quot;</span>
  set<span style="color:Gray;">-</span>item <span style="color:Blue;">function</span>:global:<span style="color:OrangeRed;">$cmd</span> <span style="color:Gray;">-</span>Value <span style="color:OrangeRed;">$p</span>
  write<span style="color:Gray;">-</span>host <span style="color:#A31515;">&quot;Added IronRuby $_ command&quot;</span>
}

</pre></div>
</div>
<p>I’m using Powershell’s standard text substitution mechanism to create
the function value as a string. Note that I’m escaping the dollar sign
in $args, so that does not get substituted the way $cmdpath does.
GetNewClosure feels cleaner, so that’s how I ended up doing it, but both
ways seem to work fine.</p>
<p>Finally, I pass an array of IronRuby commands down the pipe to
make-rubyfunction. I love the pipe command, though it feels strange to
use parentheses instead of square brackets for list comprehensions like
Python and F#!</p>
<p>Anyway, the script – as usual – is <a href="http://cid-0d9bc809858885a4.skydrive.live.com/self.aspx/DevHawk%20Content/Powershell/ironruby%7C_aliases.ps1">up on my
SkyDrive</a>.
At some point, I want to do something similar for common IronPython
scripts like
<a href="http://ironpython.codeplex.com/SourceControl/changeset/view/57298#758946">pyc</a>
and <a href="http://github.com/devhawk/ipydbg/tree/master">ipydbg</a>. Until then,
hopefully someone out there will find it useful (like maybe the IronRuby
team?).</p>
