<p>Yesterday at<a href="http://www.buildwindows.com/">//build</a>, Jesse Kaplan and I
delivered the <a href="http://channel9.msdn.com/Events/BUILD/BUILD2011/TOOL-531T">Using Windows Runtime from C# and Visual
Basic</a> talk.
In the talk, I demonstrated how natural and familiar it is to use WinRT
from C# by building a simple Metro style app. This app  takes a picture
with a webcam and implements the share charm contract in less than 15
lines of C# code.</p>
<p>Instead of making you try and read code off the recorded video stream
that should be published soon, I’ve written this walkthru to explain
exactly what I did in that demo. In addition, I’ve started from scratch
(i.e. File-&gt;New Project) so that you can follow along at home if you
wish.</p>
<p>First, you need to install the <a href="http://msdn.microsoft.com/en-us/windows/apps/br229516">Windows Developer
Preview</a>. I
recommend the x64 version with tools. Scott Hanselman has a <a href="http://www.hanselman.com/blog/GuideToInstallingAndBootingWindows8DeveloperPreviewOffAVHDVirtualHardDisk.aspx">great write
up</a>
on using boot to VHD to run the preview. (though I do disagree w/ his
assessment of dual boot. I’ve been dual booting Win7 and Win8 on my
laptop for months and it’s never ended in tears or blood). Also, you’re
going to need a webcam in order to run the app yourself.</p>
<p>Once the Windows Developer Preview is up and running, run the Socialite
app and login with your Facebook credentials. We’re going to use
Socialite to share the picture we take with the webcam. Giving it your
credentials up front makes the demo run smoother!</p>
<p>Next, fire up VS11 (aka Microsoft Visual Studio 11 Express for Windows
Developer Preview). Create a new project and select the Visual C# -&gt;
Windows Metro Style -&gt; Application template.</p>
<p>Once the new project has been created, you should be looking at the
MainPage.xaml file. Update the Grid element to contain a button and an
image.</p>
<div class="lang-xml editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">&lt;</span><span style="color:#A31515;">Grid</span> <span style="color:Red;">x:Name</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">LayoutRoot</span><span style="color:Black;">&quot;</span> <span style="color:Red;">Background</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">#FF0C0C0C</span><span style="color:Black;">&quot;</span><span style="color:Blue;">&gt;</span>
    <span style="color:Blue;">&lt;</span><span style="color:#A31515;">Button</span> <span style="color:Red;">x:Name</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">ClickMe</span><span style="color:Black;">&quot;</span> <span style="color:Red;">Click</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">ClickMe_Click</span><span style="color:Black;">&quot;</span><span style="color:Blue;">&gt;</span>Click Me<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">Button</span><span style="color:Blue;">&gt;</span>
    <span style="color:Blue;">&lt;</span><span style="color:#A31515;">Image</span> <span style="color:Red;">x:Name</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">Photo</span><span style="color:Black;">&quot;</span> <span style="color:Red;">Width</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">800</span><span style="color:Black;">&quot;</span> <span style="color:Red;">Height</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">600</span><span style="color:Black;">&quot;</span>
           <span style="color:Red;">HorizontalAlignment</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">Center</span><span style="color:Black;">&quot;</span> <span style="color:Red;">VerticalAlignment</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">Center</span><span style="color:Black;">&quot;</span><span style="color:Blue;">/&gt;</span>
<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">Grid</span><span style="color:Blue;">&gt;</span>

</pre></div>
</div>
<p>Next, hover over the Click=”ClickMe_Click” attribute of the button,
right click and select “Navigate to Event Handler”. VS11 will take you
to MainPage.xaml.cs and automatically generate a skeleton event handler
for you.</p>
<p>In my //build session, I demonstrated that VS11 can automatically
resolve WinRT namespaces the same way that it resolves managed
namespaces. But for the purposes of this blog post, it’s easier if you
just add the additional using statements we’re going to need at the top
of MainPage.xaml.cs now.</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">using</span> Windows.Media.Capture;
<span style="color:Blue;">using</span> Windows.Storage;
<span style="color:Blue;">using</span> Windows.UI.Xaml.Media.Imaging;
<span style="color:Blue;">using</span> Windows.ApplicationModel.DataTransfer;
<span style="color:Blue;">using</span> Windows.Storage.Streams;

</pre></div>
</div>
<p>Now, we add the code for ClickMe_Click:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">private</span> async <span style="color:Blue;">void</span> ClickMe_Click(<span style="color:Blue;">object</span> sender, RoutedEventArgs e)
{
    <span style="color:Blue;">var</span> ui = <span style="color:Blue;">new</span> CameraCaptureUI();
    ui.PhotoSettings.CroppedAspectRatio = <span style="color:Blue;">new</span> Size(4, 3);

    <span style="color:Blue;">var</span> file = await ui.CaptureFileAsync(CameraCaptureUIMode.Photo);

    <span style="color:Blue;">if</span> (file != <span style="color:Blue;">null</span>)
    {
        <span style="color:Blue;">var</span> stream = await file.OpenAsync(FileAccessMode.Read);

        <span style="color:Blue;">var</span> bitmap = <span style="color:Blue;">new</span> BitmapImage();
        bitmap.SetSource(stream);
        Photo.Source = bitmap;
    }
}

</pre></div>
</div>
<p>A few things to note about this code:</p>
<ul>
<li>Even though it’s using native WinRT libraries, the C# feels natural
and familiar – as if you were calling into traditional managed
libraries. We’re newing up classes, we’re passing in constructor
parameters, we’re using primitive numbers and enums, we’re assigning
properties, etc. That is very much by design.</li>
<li>We’re using a couple of async WinRT methods (CaptureFileAsync and
OpenAsync). C# 5.0′s new await keyword to make it extremely easy to
write linear looking code that doesn’t block on async operations.</li>
<li>No P/Invoke or COM Interop attributes anywhere to be seen!</li>
</ul>
<p>Finally, before we can run this code we need to declare our intent to
use the webcam. Double click on the Package.appxmanifest file, click on
the “Capabilites” tab, and then check the Webcam checkbox.</p>
<p>With the capability declared, now we can run the app. Hit F5 and VS11
will compile and deploy the Metro style app you just built. Click the
button, acknowledge that you want to let the program use the webcam,
take a pic, crop it, and there it is in your UI!</p>
<p>For the second part of the demo, I added share contract support. Here’s
how to do that.</p>
<p>First, we need to pull the stream variable into class instance scope so
that we can access it in the share contract event handler. We do that by
adding a private IRandomAccessStream variable named stream and removing
the var declarations from the line where we call OpenAsync. The updated
click event handler looks like this:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Green;">//here&#39;s the instance scope stream variable</span>
IRandomAccessStream stream;

<span style="color:Blue;">private</span> async <span style="color:Blue;">void</span> ClickMe_Click(<span style="color:Blue;">object</span> sender, RoutedEventArgs e)
{
    <span style="color:Blue;">var</span> ui = <span style="color:Blue;">new</span> CameraCaptureUI();
    ui.PhotoSettings.CroppedAspectRatio = <span style="color:Blue;">new</span> Size(4, 3);

    <span style="color:Blue;">var</span> file = await ui.CaptureFileAsync(CameraCaptureUIMode.Photo);

    <span style="color:Blue;">if</span> (file != <span style="color:Blue;">null</span>)
    {
        <span style="color:Green;">//the only change from the code above was to remove</span>
        <span style="color:Green;">//the var declaration from the following line</span>
        stream = await file.OpenAsync(FileAccessMode.Read);

        <span style="color:Blue;">var</span> bitmap = <span style="color:Blue;">new</span> BitmapImage();
        bitmap.SetSource(stream);
        Photo.Source = bitmap;
    }
}

</pre></div>
</div>
<p>Next, we need to wire up the share event handler in the XAML page’s
constructor. That’s a single line of code and VS11 intellisense writes
most of  it for you</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> MainPage()
{
    InitializeComponent();
    DataTransferManager.GetForCurrentView().DataRequested +=
        <span style="color:Blue;">new</span> TypedEventHandler&lt;DataTransferManager, DataRequestedEventArgs&gt;(MainPage_DataRequested);
}

</pre></div>
</div>
<p>If you’ve ever wired up an event handler in C# before with VS, you’ll
be familiar with the “Press TAB to insert” the correct event handler
type followed by “TAB to generate handler”. Even though hthis is a WinRT
event, VS11 helps you wire it up just the same as it does for managed
events.</p>
<p>Now we implement the share contract event handler. That’s just a simple
if statement – calling args.Request.Data.SetBitmap if the user has taken
a picture and calling args.Request.FailWithDisplayText with an error
message if they have not.</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">private</span> <span style="color:Blue;">void</span> MainPage_DataRequested(DataTransferManager sender,
    DataRequestedEventArgs args)
{
    <span style="color:Blue;">if</span> (stream == <span style="color:Blue;">null</span>)
        args.Request.FailWithDisplayText(<span style="color:#A31515;">&quot;No picture taken!&quot;</span>);
    <span style="color:Blue;">else</span>
        args.Request.Data.SetBitmap(stream);
}

</pre></div>
</div>
<p>This part of the demo shows off static methods and event
handlers. Again, note how natural and familiar it feels to use WinRT
from C#.</p>
<p>And we’re done, so hit F5 to build, deploy and run the app again.</p>
<p>I didn’t remember to do this in the //build talk, but first try
selecting the share contract <em>before</em> taking a picture. Windows will
display the “No picture taken” text in share contract window since the
user taken a picture to share yet. That’s pretty boring so dismiss the
share contract and take a picture like you did before. Then select the
share contract, select Socalite, write a pithy message and press “Share
in Facebook”.</p>
<p>That’s the entire demo! Taking a picture with the webcam, uploading to
facebook, calling native WinRT APIs from C# in a natural and familiar
way and all in just under 15 lines of code!</p>
<p>With our talk and demos, Jesse and I wanted to communicate just how
important C# and VB are in the overall developer story for Windows 8.
This demo shows off the hard work our two teams have done in order to
make sure the managed developer’s experience with Windows 8 was the best
that it could be. As I said in the talk – if you’re a managed developer,
<em>you already know how to build these Metro style apps</em>.</p>
<p>I know I <a href="http://devhawk.net/2011/09/15/the-windows-runtime/">said it
before</a>, but I
really can’t wait to see what you guys build with Windows 8!</p>
