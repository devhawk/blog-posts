<p>We interupt this blog’s coverage of OOPSLA with a quick observation &amp;
question related to development…</p>
<p>I’m hacking around writing a Word 2003 SmartTag in C# (more on the why
later). I wanted my
<a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stobjISmartTagRecognizer2.asp">recognizer</a>
to be document-dependent – i.e. depending on some custom document
properties, I wanted to change what gets recognized. A little digging
reveils that there is no way (that I could find) to access the Word
object model from the recognizer! The
<a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stmthRecognize.asp">Recognize</a>
(and
<a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stmthRecognize2.asp">Recognize2</a>)
method receives strings as parameters, but it doesn’t receive an
app-specific target object. This is unlike the Smart Tag
<a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stobjISmartTagAction.asp">Action</a>‘s
<a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stmthInvokeVerb.asp">InvokeVerb</a>
(and
<a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stmthInvokeVerb2.asp">InvokeVerb2</a>)
method which receives a <a href="http://msdn.microsoft.com/library/en-us/vbawd11/html/woobjRange1.asp">Range
object</a> (from
which you can navigate to the containing document, application and
window) when running inside of Word. Bummer.</p>
<p>I think the reason for this is that the recognizer appears to run on a
background thread while the action appears to run on the main app
thread. Furthermore, both threads are STA apartment threaded, so if I
can access the COM-based object model from the action thread, I can’t
access it directly from the recognizer thread. I actually hacked up an
add-in to provide the
<a href="http://msdn.microsoft.com/library/en-us/vbawd11/html/woproActiveDocument1.asp">ActiveDocument</a>
to the recognizer thru a backchannel and it hangs Word on shutdown. I
thought there might be an issue releasing the COM reference, but
explicitly releasing it crashes the recognizer the next time it accesses
the ActiveDocument.</p>
<p>So I’ve come to the conclusion that I somehow need to marshal this call
from the background thread to the main app thread the action and addin
are runing on (I did verify that both of those run on the same thread).
The question is, what’s the best way to do that given that I’m writing
this in C#? I thought I might use a system similar to Windows Form’s
<a href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfSystemWindowsFormsControlClassInvokeTopic.asp">Control.Invoke(…)</a>,
but it turns out that works by sending windows messages which isn’t
particularly feasible for my problem. So now I’m thinking I have pass
the ActiveDocument reference to the background thread using
<a href="http://msdn.microsoft.com/library/en-us/com/htm/cmf_a2c_8205.asp">CoMarshalInterface</a>.
Or I might be able to use
<a href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfSystemRuntimeRemotingRemotingServicesClassMarshalTopic.asp">RemotingServices.Marshal()</a>
instead.</p>
<p>Anyone have any ideas? If so, leave a comment or <a href="mailto:hpierson_at_microsoft_dot_com">drop me a
line</a>.</p>
