
					<h1>Using ASHX files to retrieve DB images</h1>
					<p>ASP.NET has a little-known (and undocumented as far as I know) feature that 
						allows you to easily implement what is known as an HTTP Handler. Basically, 
						when a request for a page comes into ASP.NET, eventually that request is 
						handled by an object that implements the IHttpHandler interface. This interface 
						includes a method called &quot;ProcessRequest&quot; that is responsible for 
						writing all of the page content to the HttpContext.Response.Output stream. ASHX 
						files allow you to easily write the IHttpHandler class without even having to 
						pre-compile it. I used ASHX files in a recent project (coming soon) to retrieve 
						images out of a SQL database. Here's how I did it.
					</p>
					<p>You need to create a file in your project with an ASHX extension. I'm retrieving 
						data from the Employees table of the Northwind sample database, so I called my 
						page NWEmpPhoto.ashx. The contents of the ASHX file are as follows:</p>
					<!--This code was color coded by TripleASP.Net's ShowCode For more information, please view http://TripleASP.Net/ShowCode.aspx You can add ShowCode to your own application by using our web service: http://TripleASP.Net/Services/ShowCode.asmx -->
<pre class="ShowCode"><span class="ColorASPNETHeader">&lt;%@ webhandler language=&quot;C#&quot; class=&quot;NWEmpPhotoHandler&quot; %&gt;</span><br> 
<br /><span class="ColorCSKeyword">using</span> System; 
<br /><span class="ColorCSKeyword">using</span> System.Web; 
<br /><span class="ColorCSKeyword">using</span> System.Data; 
<br /><span class="ColorCSKeyword">using</span> System.Data.SqlClient; 
<br />
<br /><span class="ColorCSKeyword">public</span> <span class="ColorCSKeyword">class</span> NWEmpPhotoHandler : IHttpHandler 
<br />{ 
<br />    <span class="ColorCSKeyword">public</span> <span class="ColorCSKeyword">bool</span> IsReusable { <span class="ColorCSKeyword">get</span> { <span class="ColorCSKeyword">return</span> <span class="ColorCSKeyword">true</span>; } } 
<br />
<br />    <span class="ColorCSKeyword">public</span> <span class="ColorCSKeyword">void</span> ProcessRequest(HttpContext ctx) 
<br />    { 
<br />        <span class="ColorCSKeyword">string</span> id = ctx.Request.QueryString[&quot;id&quot;]; 
<br />
<br />        SqlConnection con = <span class="ColorCSKeyword">new</span> SqlConnection(
<br />            &lt;&lt;INSERT CONNECTION <span class="ColorCSKeyword">STRING</span> HERE&gt;&gt;); 
<br />        SqlCommand cmd = <span class="ColorCSKeyword">new</span> SqlCommand(
<br />            &quot;SELECT Photo FROM Employees WHERE EmployeeID = @EmpID&quot;, con); 
<br />        cmd.CommandType = CommandType.Text; 
<br />        cmd.Parameters.Add(&quot;@EmpID&quot;, id); 
<br />
<br />        con.Open(); 
<br />        byte[] pict = (byte[])cmd.ExecuteScalar(); 
<br />        con.Close(); 
<br />
<br />        ctx.Response.ContentType = &quot;image/bmp&quot;; 
<br />        ctx.Response.OutputStream.Write(pict, 78, pict.Length - 78); 
<br />    } 
<br />} 
</pre>
					<p>As you can see, it's basically source code with the special &lt;% webhandler 
						%&gt; tag at the top. The class implements two methods - IsReusable and 
						ProcessRequest. IsReusable is for handler pooling, and as far as I can tell can 
						be safely hard coded to return true, at least in this scenario. The 
						ProcessRequest method implements the database access. It does some fairly 
						straight forward ADO.NET to retrieve the image from the DB as a byte array. The 
						primary key to the query is passed in on the query string. I'm using 
						ExecuteScalar since I'm retrieving a single column from a single row. The photo 
						column is returned as a byte array. We set the Response's correct content type 
						(image/bmp in this case) and write the byte array containing the picture to the 
						Response.OutputStream. By the way, the 78 byte offset is Northwind database 
						specific. I'm not sure why the bitmap starts 78 bytes into the blob, but I was 
						clued into the fact by an article by <a href="http://www.microsoft.com/indonesia/msdn/data04182002.asp">
							Dino Esposito</a>.</p>
					<p>
						To use the NW Photo Handler, you simply use an HTML image tag. Since the 
						primary key is passed in on the query string, you need to include it as the src 
						attribute of the image tag. Here's an example of the image tag:
					</p>
<PRE class = "ShowCode"><span class="ColorStartHtmlTag">&lt;</span><span class="ColorControlTag">img</span> src=&quot;NWEmpPhoto.ashx?id=1&quot;<span class="ColorEndHtmlTag">&gt;</span></pre>
					<h2>Updated 3/10/03</h2>
					<p>Updated the color coding of the code via TripleASP.NET's <a href="http://tripleasp.net/showcode.aspx">Show My 
					Code</a> tool.</p>

