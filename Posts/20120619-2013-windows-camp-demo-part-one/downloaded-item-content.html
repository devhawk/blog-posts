<p>Several weeks ago, I did a talk on <a href="http://devhawk.net/2012/06/08/building-winrt-components-with-cpp-cx/">building Windows Runtime components in C++</a>. As part of that talk, I did a demo that showed accessing a WinRT component written in C++ from a C# XAML application. Like I did for <a href="http://devhawk.net/2011/09/15/using-winrt-from-csharp-build-demo/">my //build talk</a>, I&#8217;ve written this walkthrough so you can follow along at home without having to read code off the recorded video stream. I&#8217;ve also published the source up on <a href="https://github.com/devhawk/WindowsCampDemo">GitHub</a>.</p>
<p>The demo had two parts &#8211; the first was a &#8220;Hello, world!&#8221; style demo, the second demonstrated wrapping an <a href="http://bitmap.codeplex.com/">existing C++ library</a> in a WinRT component to make it callable from other languages. This post covers the first part of the demo. I&#8217;ll post a walkthrough of the second part of the demo soon.</p>
<p>In order to follow along, you&#8217;ll need the <a href="http://windows.microsoft.com/en-US/windows-8/release-preview">Windows 8 Release Preview</a> as well as <a href="http://msdn.microsoft.com/en-us/windows/apps/hh852659">Visual Studio 2012 Express RC for Windows 8</a>. You should be able to use the RC version of VS 2012 <a href="http://www.microsoft.com/visualstudio/11/en-us/professional">Pro</a>, <a href="http://www.microsoft.com/visualstudio/11/en-us/premium">Premium</a> or <a href="http://www.microsoft.com/visualstudio/11/en-us/ultimate">Ultimate</a>, but I&#8217;ve only tested with Express. Note, the original presentation was done on Win8 Consumer Preview / VS 11 Beta, but I figured it made more sense to write up the walkthrough on the latest bits.</p>
<p>We&#8217;re going to start by creating the C# XAML app we&#8217;ll use as the component client. Fire up VS 2012 RC and select new project. Select Visual C# -&gt; Windows Metro Style -&gt; Blank App (XAML), name the project &#8220;WindowsCamp&#8221; and press OK. Once the project has been created, open up the MainPage.xaml file, replace the Grid element that&#8217;s there by default with the following XAML code:</p>
<pre class="brush:xml">&lt;StackPanel Background=&quot;{StaticResource ApplicationPageBackgroundThemeBrush}&quot;&gt;
    &lt;Button Click=&quot;Button_Click_1&quot;&gt;Click me&lt;/Button&gt;
    &lt;TextBlock x:Name=&quot;myText&quot; FontSize=&quot;20&quot;&gt;&lt;/TextBlock&gt;
    &lt;Image x:Name=&quot;myImage&quot;&gt;&lt;/Image&gt;
&lt;/StackPanel&gt;</pre>
<p>As you can see, my UX skills have not improved since //build.</p>
<p>Now, we need to add a project for the C++ WinRT component. Right click on solution in the Solution Explorer and select Add -&gt; New Project. In the New Project dialog, Select Visual C++ -&gt; Windows Metro Style -&gt; Windows Runtime Component, name the project &#8220;WindowsCampComponent&#8221; and press OK.</p>
<p>Once the component project has been created, we&#8217;re going to add some code to it. Open Class1.h if it&#8217;s not already open. Update the file to read as follows:</p>
<pre class="brush:cpp">#pragma once

using namespace Platform;

namespace WindowsCampComponent
{
    public ref class Class1 sealed
    {
    public:
        Class1();

        String^ SayHello(String^ name) {
            return String::Concat(
                ref new String(L&quot;Hello there &quot;),
                name);
        };
    };
}</pre>
<p>The code is a bit more complex than your typical Hello, world. The SayHello method takes a string parameter that represents someone&#8217;s name. The method concatenates the provided name with a hard coded greeting string and returns the resulting string. Doesn&#8217;t get much simpler. However, even though it&#8217;s just a single line of code there are several concepts that are important to point out:</p>
<ul>
<li>ref class &#8211; WinRT objects are projected in C++/CX as ref classes and vise-versa. Since we&#8217;re building a WinRT component to consume from C#, we define it as a ref class. Note, unless you&#8217;re writing a XAML control, all WinRT classes must be sealed.</li>
<li>Hats &#8211; The &#8216;^&#8217; character after the String type declarations is the handle-to-object modifier. It&#8217;s basically the pointer-to-object modifier (aka &#8216;*&#8217;) but for ref classes. We&#8217;ll see in the second part of the demo that you invoke members on a ref class using the same &#8216;-&gt;&#8217; syntax that you use in vanilla C++.</li>
<li>ref new &#8211; You create instances of ref clases using &#8220;ref new&#8221; instead of &#8220;new&#8221; as you do in vanilla C++. Ref new returns a handle to the newly created ref class &#8211; a String^ in this case.</li>
<li>Platform::String &#8211; C++/CX projects some non-class WinRT types as ref classes in the Platform namespace. In this case, C++/CX projects the new language interoperable string type <a href="http://msdn.microsoft.com/en-us/library/br205775(v=vs.85).aspx">HSTRING</a> as a Platform::String ref class. HSTRINGS are UTF-16, so Platform::String provides a constructor that takes a wide string literal. We imported the Platform namespace via the &#8220;using namespace&#8221; directive so we wouldn&#8217;t have to type &#8220;Platform::&#8221; multiple times.</li>
</ul>
<p>For more information about the design of the C++/CX language, check out <a href="http://blogs.msdn.com/b/vcblog/archive/2011/10/20/10228473.aspx">Jim Springfield&#8217;s post</a> on the <a href="http://blogs.msdn.com/b/vcblog/">Visual C++ team blog</a>.</p>
<p>Now that we&#8217;ve written our WinRT component, we&#8217;ll write the code to consume it in C#. First, we need to add a reference to the C++ WinRT component project in our C# Metro style XAML app. WinRT references are added just like traditional CLR references &#8211; via the Add Reference dialog. Right click on the WindowsCamp node of the Solution explorer, select &#8220;Add Reference&#8230;&#8221; from the menu, click the check box next to the WindowsCampComponent project from the solution and press OK.</p>
<p>Go back to MainPage.xaml and double click on the button labeled &#8220;Click Me&#8221; in the designer. This will add a click event handler named Button_Click_1 and take you to MainPage.xaml.cs so you can write the code for it. Type in &#8220;var wcc = new Windows&#8221; and look at the resulting intellisense list. Notice that WindowsCampComponent is missing.</p>
<p><img class="alignnone size-full wp-image-2004" title="WCDemo1-Intellisense1" src=".\WCDemo1-Intellisense1.png" alt width="496" height="241"></p>
<p>This is because the C++ component hasn&#8217;t been compiled yet. We need compile the C++ component project in order to generate the Windows metadata file (aka the file with the .winmd extension) that is used to drive intellisense. Delete the line of code you just added and compile the solution. Now type that line of code again, and you&#8217;ll notice that the WindowsCampComponent namespace is available.</p>
<p><img class="alignnone size-full wp-image-2005" title="WCDemo1-Intellisense2" src=".\WCDemo1-Intellisense2.png" alt width="490" height="238"></p>
<p>Now, update the button click event handler to read as follows:</p>
<pre class="brush:csharp">private void Button_Click_1(object sender, RoutedEventArgs e)
{
    var wcc = new WindowsCampComponent.Class1();
    myText.Text = wcc.SayHello(&quot;Herb Sutter&quot;);
}</pre>
<p><img class="size-thumbnail wp-image-2008 alignleft" title="WCDemo1-RunningApp" src=".\WCDemo1-RunningApp-e1340161688130-150x74.png" alt width="150" height="74">Now, run the app, click the &#8220;Click Me&#8221; button and marvel at the wonder of WinRT language interop to print a greeting to Herb Sutter. I used <a href="http://herbsutter.com/">Herb Sutter</a> from the C++ team since he was the keynote speaker at the Windows Camp event and was standing in the back of the room when I did the demo.</p>
<p>And that&#8217;s it for the Hello, world demo. Kind of a lot of steps for essentially 3 lines of code &#8211; 1 line of component code and 2 lines of client code. However, we did get the infrastructure set up so we add more substantial code in the next post.</p>
