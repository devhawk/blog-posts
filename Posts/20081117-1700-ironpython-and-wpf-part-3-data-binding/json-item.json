{"status":"ok","post":{"id":1190,"type":"post","slug":"ironpython-and-wpf-part-3-data-binding","url":"http:\/\/devhawk.net\/2008\/11\/17\/ironpython-and-wpf-part-3-data-binding\/","status":"publish","title":"IronPython and WPF Part 3: Data Binding","title_plain":"IronPython and WPF Part 3: Data Binding","content":"<p>Here\u2019s the short version of this post: data binding in WPF to IPy objects just works&#8230;mostly. However, I\u2019m guessing you are much more interested in the long version.<\/p>\n<p>Typically, data binding depends on reflection. For example, the following snippet of XAML defines a data bound list box where the title property of each object in the bound collection gets bound to the text property of a text block control. WPF would typically find the title property of the bound objects via reflection.<\/p>\n<pre class=\"brush: xml\">\n&lt;ListBox Grid.Column=\"0\" x:Name=\"listbox1\" &gt;\n  &lt;ListBox.ItemTemplate&gt;\n    &lt;DataTemplate&gt;\n      &lt;TextBlock Text=\"{Binding Path=title}\" \/&gt;\n    &lt;\/DataTemplate&gt;\n  &lt;\/ListBox.ItemTemplate&gt;\n&lt;\/ListBox&gt;\n<\/pre>\n<p>The problem is that IronPython objects don\u2019t support reflection \u2013 or more accurately, reflection won\u2019t give you the answer you\u2019re expecting. Every IPy object does have a static type, but it implements Python\u2019s dynamic type model. [1] Thus, if you reflect on the IPy object looking for the title property or field, you won\u2019t find it. It might seem we\u2019re in a bit of a bind (pun intended). However, WPF does <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/ms743643.aspx\">provide an out<\/a>:<\/p>\n<blockquote><p>\u201cYou can bind to public properties, sub-properties, as well as indexers of any common language runtime (CLR) object. The binding engine uses CLR reflection to get the values of the properties. Alternatively, objects that implement <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/system.componentmodel.icustomtypedescriptor.aspx\">ICustomTypeDescriptor<\/a> or have a registered <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/system.componentmodel.typedescriptionprovider.aspx\">TypeDescriptionProvider<\/a> also work with the binding engine.\u201d       <br \/>WPF <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/ms743643.aspx\">Binding Sources Overview<\/a>, MSDN Library<\/p>\n<\/blockquote>\n<p style=\"margin-right: 0px\" dir=\"ltr\">Luckily for us, IronPython objects implement ICustomTypeDescriptor [2]. That snippet of XAML above? It\u2019s straight from my photo viewing app. All I had to do was define the data template in the list box XAML then set the ItemsSource property of the list box instance. <\/p>\n<pre class=\"brush: python\">\nw.listbox1.ItemsSource = albumsFeed.channel.item\n<\/pre>\n<p style=\"margin-right: 0px\" dir=\"ltr\">As I said, it just works. However, I did hit one small snag \u2013 hence the \u201cmostly\u201d caveat above. <\/p>\n<p style=\"margin-right: 0px\" dir=\"ltr\">If you look at the <a href=\"http:\/\/techiewife.spaces.live.com\/photos\/feed.rss\">top level WL Spaces photos feed<\/a>, you\u2019ll see that each item\u2019s title starts with \u201cPhoto Album:\u201d. Yet in the <a href=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/IronPythonandWPF_EFC4\/image_4.png\" class=\"grouped_elements\" rel=\"tc-fancybox-group1190\">screenshot of my app<\/a>, you\u2019ll notice that I\u2019ve stripped that redundant text out of the title. Typically, if you want to change the bound value during the binding process, you build an <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/ms752347.aspx#data_conversion\">IValueConverter<\/a> class. I needed two value conversions in my app, stripping \u201cPhoto Album:\u201d for the album list box and converting a string URL into a BitmapImage for the image list box. <\/p>\n<p style=\"margin-right: 0px\" dir=\"ltr\">IronPython objects can inherit from a .NET interface, so there\u2019s no problem building an IValueConverter. However, in order to use a custom IValueConverter from XAML, you need to <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/ms752091.aspx\">declare it in XAML as a static resource<\/a>. However, as you might imagine, dynamic IPy objects don\u2019t work as static resources. So while I can define an IValueConverter in Python, I can\u2019t create one from XAML.<\/p>\n<p style=\"margin-right: 0px\" dir=\"ltr\">There are a few possible solutions to this. The first is to build up the data template in code. If you do that, they you can <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/ms742863.aspx\">programmatically add the converter to the binding<\/a>. I was hopeful that I could define the data template in XAML then manipulate the binding, but there doesn\u2019t appear to be any way to do that. Another option would be to build some type of generic IValueConverter class in C# that loads either an IPy based IValueConverter or embedded python conversion code. That\u2019s problematic because those IPy object would need to be created in the right ScriptRuntime, and there\u2019s no built-in way to access that. There are also a small set of XamlReader extensions such as <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/system.windows.markup.xamltypemapper.aspx\">XamlTypeMapper<\/a> that might be able to provide the right hook into the XAML parsing to allow IronPython based conversion.<\/p>\n<p style=\"margin-right: 0px\" dir=\"ltr\">In the end, I took the easiest way out \u2013 I transformed the data to be bound before binding it. It\u2019s cheating of sorts, but given the read-only nature of this app, it was the easiest thing to do. So the actual line of code to set listbox1\u2019s ItemsSource looks like this:<\/p>\n<pre class=\"brush: python\">\nclass Album(object):     \n  def __init__(self, item):     \n    self.title = item.title.Substring(13)     \n    self.itemRSS = item.itemRSS     \n     \nw.listbox1.ItemsSource = [Album(item) for item in albumsFeed.channel.item]\n<\/pre>\n<p style=\"margin-right: 0px\" dir=\"ltr\">I create a Python class for each RSS item in the feed, saving the stripped title and the album RSS URL as fields. It\u2019s kinda annoying to basically be parsing the feed twice, but at least it\u2019s not much code. Python\u2019s list comprehension syntax makes creating a list of Albums from a list of RSS items a single line of code. I do something very similar for data binding the second list box:<\/p>\n<pre class=\"brush: python\">\nclass Picture(object):     \n  def __init__(self, item):     \n    self.title = item.title  \n    self.picture = BitmapImage(Uri(item.enclosure.url + \":thumbnail\"))     \n\nw.listbox2.ItemsSource = [Picture(item) for item in albumfeed.channel.item]\n<\/pre>\n<p style=\"margin-right: 0px\" dir=\"ltr\">Here I\u2019m not only converting the raw data (adding \u201c:thumbnail\u201d at the end of the URL) but also changing the data type from string to BitmapImage. I\u2019m binding to an image object in the second list box, but to do that I need a BitmapImage instead of a string.<\/p>\n<p style=\"margin-right: 0px\" dir=\"ltr\">This \u201cconvert the data first\u201d approach feels like a hack to me. After I get this series of posts done, I am planning on going back and improving this sample. Hopefully, I can find a better approach to value conversions. Any gurus out there on XAML parsing, please feel free to drop me a line or leave me a comment. <\/p>\n<p style=\"margin-right: 0px\" dir=\"ltr\">\n<hr \/>\n<p>[1] you can access the underlying CLR type for any Python type via the clr.GetClrType method. You an also check out the CreateNewType method from <a href=\"http:\/\/www.codeplex.com\/IronPython\/SourceControl\/FileView.aspx?itemId=649510&amp;changeSetId=43433\">NewTypeMaker.cs<\/a><\/p>\n<p>[2] I spent the better part of an afternoon trying to make TypeDescriptionProviders work before Dino pointed out that we already support ICustomTypeDescriptor in Python objects. I didn\u2019t realize at first because I had a case sensitivity bug in my original prototype code &#8211; it turns out that \u201cTitle\u201d != \u201ctitle\u201d. <\/p>\n","excerpt":"<p>Here\u2019s the short version of this post: data binding in WPF to IPy objects just works&#8230;mostly. However, I\u2019m guessing you are much more interested in the long version. Typically, data binding depends on reflection. For example, the following snippet of XAML defines a data bound list box where the title property of each object in [&hellip;]<\/p>\n","date":"2008-11-17 17:00:17","modified":"2008-11-17 17:00:17","categories":[{"id":252,"slug":"ironpython","title":"IronPython","description":"","parent":0,"post_count":99}],"tags":[{"id":271,"slug":"wpf","title":"WPF","description":"","post_count":8}],"author":{"id":1,"slug":"admin","name":"DevHawk","first_name":"Harry","last_name":"Pierson","nickname":"DevHawk","url":"","description":""},"comments":[{"id":2144,"name":"Apolon Ivankovic","url":"http:\/\/torqsoftware.com","date":"2008-11-18 01:14:31","content":"<p>From my understanding, Silverlight uses solely Reflection based binding with no support for ICustomTypeDescriptor or anything similar. Given this, then the conclusion is that there&#8217;s no decent data binding story for the DLR languages in Silverlight. Is this correct? <\/p>\n<p>It seems like a shame. Is there any way to alter the IronPython\/DLR behaviour so that it does generate IL defined properties\/methods for some scenarios? i.e. even at the cost of dynamism for those scenarios.<\/p>\n","parent":0}],"attachments":[],"comment_count":1,"comment_status":"closed","custom_fields":{"dasblog_entryid":["81c4ca71-425d-4f5b-90c2-dba60eab4333"],"dasblog_compressedtitle":["IronPython+And+WPF+Part+3+Data+Binding"],"dasblog_compressedtitleunique":["2008\/11\/18\/IronPython+And+WPF+Part+3+Data+Binding"]}},"previous_url":"http:\/\/devhawk.net\/2008\/11\/14\/ironpython-and-wpf-part-2-loading-xaml\/","next_url":"http:\/\/devhawk.net\/2008\/11\/19\/ironpython-and-wpf-part-4-background-processing\/"}