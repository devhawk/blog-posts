{"status":"ok","post":{"id":1178,"type":"post","slug":"the-fifth-assembly","url":"http:\/\/devhawk.net\/2008\/10\/21\/the-fifth-assembly\/","status":"publish","title":"The Fifth Assembly","title_plain":"The Fifth Assembly","content":"<p>As I\u2019ve <a href=\"http:\/\/devhawk.net\/2008\/09\/17\/DLR+Namespace+Change+Fire+Drill.aspx\">written previously<\/a>, we\u2019ve had a few challenges recently with name collisions in the DLR. In that post, I described how we had solved \u2013 or thought we solved, as it turned out \u2013 the problem with ExtensionAttribute name collisions between Microsoft.Scripting.Core.dll and System.dll. <\/p>\n<p>However, as it turns out, having lots of copies of the same type <a href=\"http:\/\/lists.ironpython.com\/pipermail\/users-ironpython.com\/2008-September\/008485.html\">didn\u2019t solve the problem<\/a>. Since ExtensionAttribute is a known type to the C# 3.0 compiler, it has to choose one of the multiple copies that are in the project. We <em>thought<\/em> that given a choice, it would favor the System.Core version. However, what folks discovered after we released Beta 5 is that C# 3.0 will choose the <em>first<\/em> copy of ExtensionAttribute that it finds. So if you have System.Core.dll and IronPython referenced in your project, and you define your own extension methods, the compile fails if the C# 3.0 compiler finds one of the IronPython or DLR private copies of ExtensionAttribute before the public copy in System.Core.<\/p>\n<p>Furthermore, there doesn\u2019t seem to be any way to set the reference order in MSBuild files. I\u2019ve never dug deep into the MSBuild file format, but changing the order of the references in the csproj file didn\u2019t seem to effect the order the references were passed to the C# compiler. I\u2019m guessing we might be able to change this by fiddling with the <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/9ad3f294.aspx\">ResolveAssemblyReference task<\/a>, but we didn\u2019t want to force low level MSBuild file hacking on our user base.<\/p>\n<p>We looked at a variety of other solutions, including rewriting the IL after compilation to change the namespace of the ExtensionAttribute. However, we had trouble making that solution work and besides, changing the ExtensionAttribute namespace would have broken anyone using the existing DLR or IPy extension methods. So instead, we went with a different solution that we like to refer to as \u201cThe Fifth Assembly\u201d around the office.<\/p>\n<p><a href=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/TheFifthAssembly_B085\/image_2.png\" class=\"grouped_elements\" rel=\"tc-fancybox-group1178\"><img style=\"border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; margin-left: 0px; border-left-width: 0px; margin-right: 0px\" title=\"IPy References\" border=\"0\" alt=\"IPy References\" align=\"right\" src=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/TheFifthAssembly_B085\/image_thumb.png\" width=\"312\" height=\"216\" \/><\/a>In IronPython 2.0 Beta 5, there were four DLLs that implement IronPython: IronPython.dll, IronPython.Modules.dll, Microsoft.Scripting.dll and Microsoft.Scripting.Core.dll. In our RC1 release, we\u2019ve added \u201cThe Fifth Assembly\u201d: Microsoft.Scripting.ExtensionAttribute.dll. As you might guess from its name, it has only a single public type: ExtensionAttribute. By having ExtensionAttribute in its own dedicated assembly, we can avoid the type collision at compile time by not referencing both System.Core.dll and Microsoft.Scripting.ExtensionAttribute.dll in the same project. <\/p>\n<p>In IronPython, we reference the ExtensionAttribute assembly because we use the C# 3.0 complier but IPy has to be able to run on .NET Framework 2.0 SP1. <a href=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/TheFifthAssembly_B085\/image_4.png\" class=\"grouped_elements\" rel=\"tc-fancybox-group1178\"><img style=\"border-right-width: 0px; margin: 0px 5px 0px 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px\" title=\"image\" border=\"0\" alt=\"image\" align=\"left\" src=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/TheFifthAssembly_B085\/image_thumb_1.png\" width=\"247\" height=\"205\" \/><\/a>However, projects that embed IronPython in a .NET 3.5 project (aka C# 3.0 or VB 9.0) will reference System.Core instead. The only reason why you would explicitly use the ExtensionAttribute assembly was that if you, like us, wanted to build your app with .NET 3.5, use extension methods but still be compatible with .NET 2.0 SP1. We\u2019re guessing there aren\u2019t many of our customers doing that, but if you are, explicitly referencing ExtensionAttribute will work just as it does for compiling IronPython itself.<\/p>\n<p>It\u2019s important to remember two things about the Fifth Assembly:<\/p>\n<ol>\n<li>Never reference System.Core and Microsoft.Scripting.ExtensionAttribute in the same project. <\/li>\n<li>Always deploy Microsoft.Scripting.ExtensionAttribute.dll as part of any solution that embeds IronPython (or IronRuby or vanilla DLR for that matter), even if you don\u2019t reference it explicitly within your project. <\/li>\n<\/ol>\n<p>This change is public in the source code as of <a href=\"http:\/\/www.codeplex.com\/IronPython\/SourceControl\/DirectoryView.aspx?SourcePath=&amp;changeSetId=42076\">change set 42076<\/a> and will also be in the nearly-ready RC1 release of IronPython 2.0. If you\u2019ve got any questions or &lt;shudder&gt; find any more issues with this solution, please let us know right away.<\/p>\n","excerpt":"<p>As I\u2019ve written previously, we\u2019ve had a few challenges recently with name collisions in the DLR. In that post, I described how we had solved \u2013 or thought we solved, as it turned out \u2013 the problem with ExtensionAttribute name collisions between Microsoft.Scripting.Core.dll and System.dll. However, as it turns out, having lots of copies of [&hellip;]<\/p>\n","date":"2008-10-21 12:42:41","modified":"2008-10-21 12:42:41","categories":[{"id":252,"slug":"ironpython","title":"IronPython","description":"","parent":0,"post_count":99}],"tags":[{"id":231,"slug":"dlr","title":"DLR","description":"","post_count":25}],"author":{"id":1,"slug":"admin","name":"DevHawk","first_name":"Harry","last_name":"Pierson","nickname":"DevHawk","url":"","description":""},"comments":[{"id":2124,"name":"Dave","url":"","date":"2008-10-23 00:16:22","content":"<p>Hi,<\/p>\n<p>This is perhaps not the best place to report this, but I couldn&#8217;t find the associated ticket in the CodePlex issue tracker.  I&#8217;ve just updated to RC1.  My project is a fairly basic WPF project and references System.Core; it previously got the warning about the duplicate definition.  Now when I build I get the following error:<\/p>\n<p>Target MarkupCompilePass1:<br \/>\n    C:WindowsMicrosoft.NETFrameworkv3.5Microsoft.WinFX.targets(294,9): error MC1000: Unknown build error, &#8216;Cannot resolve dependency to assembly &#8216;Microsoft.Scripting.ExtensionAttribute, Version=1.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&#8242; because it has not been preloaded. When using the ReflectionOnly APIs, dependent assemblies must be pre-loaded or loaded on demand through the ReflectionOnlyAssemblyResolve event.&#8217; <\/p>\n<p>Initially I just used RC1 from the zip file, but I also tried installing from the .msi on the chance the it would install the assemblies into the GAC but it didn&#8217;t do that.  Have I missed something in my project configuration?<\/p>\n<p>Thanks,<br \/>\nDave<\/p>\n","parent":0},{"id":2125,"name":"Chris Cavanagh","url":"http:\/\/chriscavanagh.wordpress.com","date":"2008-11-12 12:44:33","content":"<p>Harry &#8211; Will Microsoft.Scripting.Core and System.Core eventually be merged? I&#8217;m hitting some problems using Microsoft.Scripting.Core in a Silverlight 2 project (it wants a System.Core reference too).<\/p>\n","parent":0},{"id":2126,"name":"DevHawk","url":"","date":"2008-11-18 16:17:42","content":"<p>@Dave, Did you create a new issue on CodePlex?<\/p>\n<p>@Chris, Microsoft.Scripting.Core is essentially the .NET 4.0 version of System.Core. The merge has already been done<\/p>\n","parent":0}],"attachments":[],"comment_count":3,"comment_status":"closed","custom_fields":{"dasblog_entryid":["c229d24e-6da3-40cc-8d5f-b09193b85d65"],"dasblog_compressedtitle":["The+Fifth+Assembly"],"dasblog_compressedtitleunique":["2008\/10\/21\/The+Fifth+Assembly"]}},"previous_url":"http:\/\/devhawk.net\/2008\/10\/19\/the-pdc-prep-death-march-its-almost-over\/","next_url":"http:\/\/devhawk.net\/2008\/10\/24\/ironpython-2-0-release-candidate\/"}