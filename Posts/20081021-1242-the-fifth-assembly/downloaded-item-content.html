<p>As I&#8217;ve <a href="http://devhawk.net/2008/09/17/DLR+Namespace+Change+Fire+Drill.aspx">written previously</a>, we&#8217;ve had a few challenges recently with name collisions in the DLR. In that post, I described how we had solved &#8211; or thought we solved, as it turned out &#8211; the problem with ExtensionAttribute name collisions between Microsoft.Scripting.Core.dll and System.dll. </p>
<p>However, as it turns out, having lots of copies of the same type <a href="http://lists.ironpython.com/pipermail/users-ironpython.com/2008-September/008485.html">didn&#8217;t solve the problem</a>. Since ExtensionAttribute is a known type to the C# 3.0 compiler, it has to choose one of the multiple copies that are in the project. We <em>thought</em> that given a choice, it would favor the System.Core version. However, what folks discovered after we released Beta 5 is that C# 3.0 will choose the <em>first</em> copy of ExtensionAttribute that it finds. So if you have System.Core.dll and IronPython referenced in your project, and you define your own extension methods, the compile fails if the C# 3.0 compiler finds one of the IronPython or DLR private copies of ExtensionAttribute before the public copy in System.Core.</p>
<p>Furthermore, there doesn&#8217;t seem to be any way to set the reference order in MSBuild files. I&#8217;ve never dug deep into the MSBuild file format, but changing the order of the references in the csproj file didn&#8217;t seem to effect the order the references were passed to the C# compiler. I&#8217;m guessing we might be able to change this by fiddling with the <a href="http://msdn.microsoft.com/en-us/library/9ad3f294.aspx">ResolveAssemblyReference task</a>, but we didn&#8217;t want to force low level MSBuild file hacking on our user base.</p>
<p>We looked at a variety of other solutions, including rewriting the IL after compilation to change the namespace of the ExtensionAttribute. However, we had trouble making that solution work and besides, changing the ExtensionAttribute namespace would have broken anyone using the existing DLR or IPy extension methods. So instead, we went with a different solution that we like to refer to as &#8220;The Fifth Assembly&#8221; around the office.</p>
<p><a class="grouped_elements" href=".\image_2.png" rel="tc-fancybox-group1178"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; margin-left: 0px; border-left-width: 0px; margin-right: 0px" title="IPy References" border="0" alt="IPy References" align="right" src=".\image_thumb.png" width="312" height="216"></a>In IronPython 2.0 Beta 5, there were four DLLs that implement IronPython: IronPython.dll, IronPython.Modules.dll, Microsoft.Scripting.dll and Microsoft.Scripting.Core.dll. In our RC1 release, we&#8217;ve added &#8220;The Fifth Assembly&#8221;: Microsoft.Scripting.ExtensionAttribute.dll. As you might guess from its name, it has only a single public type: ExtensionAttribute. By having ExtensionAttribute in its own dedicated assembly, we can avoid the type collision at compile time by not referencing both System.Core.dll and Microsoft.Scripting.ExtensionAttribute.dll in the same project. </p>
<p>In IronPython, we reference the ExtensionAttribute assembly because we use the C# 3.0 complier but IPy has to be able to run on .NET Framework 2.0 SP1. <a class="grouped_elements" href=".\image_4.png" rel="tc-fancybox-group1178"><img style="border-right-width: 0px; margin: 0px 5px 0px 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" align="left" src=".\image_thumb_1.png" width="247" height="205"></a>However, projects that embed IronPython in a .NET 3.5 project (aka C# 3.0 or VB 9.0) will reference System.Core instead. The only reason why you would explicitly use the ExtensionAttribute assembly was that if you, like us, wanted to build your app with .NET 3.5, use extension methods but still be compatible with .NET 2.0 SP1. We&#8217;re guessing there aren&#8217;t many of our customers doing that, but if you are, explicitly referencing ExtensionAttribute will work just as it does for compiling IronPython itself.</p>
<p>It&#8217;s important to remember two things about the Fifth Assembly:</p>
<ol>
<li>Never reference System.Core and Microsoft.Scripting.ExtensionAttribute in the same project. </li>
<li>Always deploy Microsoft.Scripting.ExtensionAttribute.dll as part of any solution that embeds IronPython (or IronRuby or vanilla DLR for that matter), even if you don&#8217;t reference it explicitly within your project. </li>
</ol>
<p>This change is public in the source code as of <a href="http://www.codeplex.com/IronPython/SourceControl/DirectoryView.aspx?SourcePath=&changeSetId=42076">change set 42076</a> and will also be in the nearly-ready RC1 release of IronPython 2.0. If you&#8217;ve got any questions or &lt;shudder&gt; find any more issues with this solution, please let us know right away.</p>
