{"status":"ok","post":{"id":1267,"type":"post","slug":"add-bcd-vhd-ps1","url":"http:\/\/devhawk.net\/2009\/06\/18\/add-bcd-vhd-ps1\/","status":"publish","title":"Add-Bcd-Vhd.ps1","title_plain":"Add-Bcd-Vhd.ps1","content":"<p>I *LOVE* the new boot from VHD feature in Win7. I am primarily using it for doing some <a href=\"http:\/\/www.microsoft.com\/visualstudio\/en-us\/products\/2010\/default.mspx\">VS 2010<\/a> dogfooding without messing up my primary drive partition. But man, the process for setting up a VHD for booting is brutal. Scott Hanselman did a great job <a href=\"http:\/\/www.hanselman.com\/blog\/LessVirtualMoreMachineWindows7AndTheMagicOfBootToVHD.aspx\">laying out the steps<\/a>, but I wanted something a bit more productive.<\/p>\n<p>First, I created a clean Win7 RC VHD and zipped it up for easy storage. The basic Win7 RC VHD is just under 5GB, but compresses down to about 1.5GB with <a href=\"http:\/\/www.7-zip.org\/\">7-zip<\/a>. I used the <a href=\"http:\/\/blogs.technet.com\/aviraj\/archive\/2009\/01\/18\/windows-7-boot-from-vhd-first-impression-part-2.aspx\">ImageX process<\/a> Aviraj described though in the future I\u2019ll use the <a href=\"http:\/\/code.msdn.microsoft.com\/InstallWindowsImage\">Install-WindowsImage<\/a> script. Install-WindowsImage is more convenient to use because it will list the indexes within a given .wim file instead of making you grovel thru an XML file like ImageX does. Also Install-WindowsImage is 27k download while ImageX is part of the 1.4 <em>gigabyte <\/em><a href=\"http:\/\/www.microsoft.com\/downloads\/details.aspx?familyid=60A07E71-0ACB-453A-8035-D30EAD27EF72&amp;displaylang=en\">Windows Automated Installation Kit<\/a>. Look, I\u2019m not hurting for bandwidth, but I don\u2019t see the point of downloading 54442 times more data for a utility that isn\u2019t as useful.<\/p>\n<p>Once you\u2019ve created the VHD, you need to update your Boot Configuration Data, or BCD for short, using the appropriately named <a href=\"http:\/\/technet.microsoft.com\/en-us\/library\/cc709667.aspx\">BCDEdit utility<\/a>. The process is fairly straight forward, if tedious. You have to run BCDEdit four times, copy the configuration GUID to the clipboard and type out the path to the VHD in a slightly funky syntax. Blech. So I built a PowerShell script to automate updating the BCD, called <a href=\"http:\/\/cid-0d9bc809858885a4.skydrive.live.com\/self.aspx\/DevHawk%20Content\/Powershell\/add-bcd-vhd.ps1\">add-bcd-vhd<\/a>. You can get it from <a href=\"http:\/\/cid-0d9bc809858885a4.skydrive.live.com\/self.aspx\/DevHawk%20Content\/Powershell\/add-bcd-vhd.ps1\">my skydrive<\/a>. Pass in the name of the BCD entry and the path to the VHD and add-bcd-vhd will do the rest.<\/p>\n<p>I was <a href=\"http:\/\/twitter.com\/DevHawk\/status\/2202944230\">whining on Twitter<\/a> yesterday that there\u2019s no PowerShell specific tools for managing the BCD data. Add-bcd-vhd just runs bcdedit behind the scenes and processes the text output with regular expressions. Ugly, but effective. I decided to spend some time trying accessing the BCD data from its <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/bb986746.aspx\">WMI provider<\/a>, but that turned out to be way too much of a hassle to be effective. If someone else out there knows how to use the BCD WMI provider from PowerShell, I\u2019d appreciate some sample code.<\/p>\n","excerpt":"<p>I *LOVE* the new boot from VHD feature in Win7. I am primarily using it for doing some VS 2010 dogfooding without messing up my primary drive partition. But man, the process for setting up a VHD for booting is brutal. Scott Hanselman did a great job laying out the steps, but I wanted something [&hellip;]<\/p>\n","date":"2009-06-18 13:39:57","modified":"2009-06-18 13:39:57","categories":[{"id":283,"slug":"windows","title":"Windows","description":"","parent":0,"post_count":16}],"tags":[{"id":230,"slug":"powershell","title":"PowerShell","description":"","post_count":41}],"author":{"id":1,"slug":"admin","name":"DevHawk","first_name":"Harry","last_name":"Pierson","nickname":"DevHawk","url":"","description":""},"comments":[{"id":2221,"name":"Barry Kelly","url":"http:\/\/barrkel.blogspot.com\/","date":"2009-06-18 15:34:08","content":"<p>How about a return to tried and trusted technology from the 70s? Why the hell was boot.ini gotten rid of?<\/p>\n<p>Oh I know, &#8220;too vulnerable to malicious attacks&#8221;. That makes no sense at all; if the OS can&#8217;t protect boot.ini with permissions, why the hell does anyone think an obfuscated format will do better?<\/p>\n<p>It&#8217;s crap like this which have meant I haven&#8217;t moved on (I can&#8217;t say &#8220;upgraded&#8221;) to Vista, and is only one of many reasons why I won&#8217;t move to Win7 either, not for a good few years, or at least until I can replace the shell with an XP-alike &#8211; most especially the Start Menu, the Explorer items pane, and getting rid of the Mac-alike task bar. (I hate Macs more.) Sigh.<\/p>\n","parent":0}],"attachments":[],"comment_count":1,"comment_status":"closed","custom_fields":{"dasblog_entryid":["17cd359b-7a77-47ad-a06d-9ba7d2621021"],"dasblog_compressedtitle":["AddBcdVhdps1"],"dasblog_compressedtitleunique":["2009\/06\/18\/AddBcdVhdps1"]}},"previous_url":"http:\/\/devhawk.net\/2009\/06\/18\/__clrtype__-metaclasses-named-attribute-parameters\/","next_url":"http:\/\/devhawk.net\/2009\/07\/08\/microsoft-scripting-debugging\/"}