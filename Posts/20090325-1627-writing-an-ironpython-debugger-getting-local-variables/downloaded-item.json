{"status":"ok","post":{"id":1237,"type":"post","slug":"writing-an-ironpython-debugger-getting-local-variables","url":"http:\/\/devhawk.net\/2009\/03\/25\/writing-an-ironpython-debugger-getting-local-variables\/","status":"publish","title":"Writing an IronPython Debugger: Getting Local Variables","title_plain":"Writing an IronPython Debugger: Getting Local Variables","content":"<p>I just pushed out a new drop of ipydbg that includes the first cut of support for showing local variables. Getting the value for a local variable is actually pretty simple. The CorFrame object (which hangs off active_thread) includes a method to <a href=\"http:\/\/github.com\/devhawk\/ipydbg\/blob\/442527b0aed3ac2f7ecf6ab8f5f7e93ad03090f2\/CorDebug\/CorDebug\/Thread.cs#L448\">get a local variable by index<\/a> as well getting a <a href=\"http:\/\/github.com\/devhawk\/ipydbg\/blob\/442527b0aed3ac2f7ecf6ab8f5f7e93ad03090f2\/CorDebug\/CorDebug\/Thread.cs#L475\">count of all local variables<\/a>. The problem with these functions is that they don\u2019t provide the name of the variable. For that, you\u2019ve got to look in debug symbols. <\/p>\n<p>From a CorFrame, you can retrieve the associated CorFunction. Since I added <a href=\"http:\/\/devhawk.net\/2009\/03\/21\/Writing+An+IronPython+Debugger+A+Little+HackhelliperrhellipCleanup.aspx\">symbol reader support to CorModule<\/a>, I <a href=\"http:\/\/github.com\/devhawk\/ipydbg\/commit\/fc6dd0684f6b299db2eabcfe1803cab6231ea93f#diff-2\">added support for directly retrieving<\/a> the ISymbolMethod for a CorFunction. From the method symbols, I can get the <a href=\"http:\/\/github.com\/devhawk\/ipydbg\/blob\/442527b0aed3ac2f7ecf6ab8f5f7e93ad03090f2\/CorDebug\/CorSymbolStore\/symmethod.cs#L167\">root lexical scope<\/a> of the method. And from the symbol scope, I can <a href=\"http:\/\/github.com\/devhawk\/ipydbg\/blob\/442527b0aed3ac2f7ecf6ab8f5f7e93ad03090f2\/CorDebug\/CorSymbolStore\/SymScope.cs#L156\">get the locals<\/a>. Scopes can be nested, so to get all the locals for a given function, you need to iterate thru all the <a href=\"http:\/\/github.com\/devhawk\/ipydbg\/blob\/442527b0aed3ac2f7ecf6ab8f5f7e93ad03090f2\/CorDebug\/CorSymbolStore\/SymScope.cs#L119\">child scopes<\/a> as well.<\/p>\n<p>So here\u2019s my get_locals function:<\/p>\n<pre class=\"brush: python\">\ndef get_locals(frame, scope=None, offset=None, show_hidden=False):  \n    #if the scope is unspecified, try and get it from the frame \n    if scope == None:  \n        symmethod = frame.Function.GetSymbolMethod()  \n        if symmethod != None:  \n            scope = symmethod.RootScope  \n        #if scope still not available, yield the local variables \n        #from the frame, with auto-gen'ed names (local_1, etc) \n        else:  \n          for i in range(frame.GetLocalVariablesCount()):  \n            yield \"local_%d\" % i, frame.GetLocalVariable(i)  \n          return  \n\n    #if we have a scope, get the locals from the scope  \n    #and their values from the frame \n    for lv in scope.GetLocals():  \n        #always skip $site locals - they are cached callsites and  \n        #not relevant to the ironpython developer \n        if lv.Name == \"$site\": continue  \n        if not lv.Name.startswith(\"$\") or show_hidden:  \n          v = frame.GetLocalVariable(lv.AddressField1)  \n          yield lv.Name, v  \n\n    if offset == None: offset = frame.GetIP()[0]  \n\n    #recusively call get_locals for all the child scopes \n    for s in scope.GetChildren():  \n      if s.StartOffset &lt;= offset and s.EndOffset &gt;= offset:  \n        for ret in get_locals(frame, s, offset, show_hidden):  \n          yield ret\n<\/pre>\n<p>The function is designed to automatically retrieve the scope and offset, if they\u2019re available. That way, I can simply call get_locals with the frame argument and it does the right thing. For example, if you don\u2019t pass in a symbol scope explicitly get_locals will attempt to retrieve the debug symbols. If debug symbols aren\u2019t available, iterates over the locals in the frame and yields each with a fake name (local_0, local_1, etc). If the debug symbols are available, then it iterates over the locals in the scope, then calls itself for each of the child scopes (skipping child scopes who\u2019s offset range doesn\u2019t overlap with the current offset).<\/p>\n<p>The other feature of get_locals is deciding which locals to include. As you might expect, IronPython emits some local variables that are for internal runtime use. These variables get prefixed with a dollar sign. The dollar sign is not a legal identifier character in C# or Python, but IL has no problem with it. If you pass in False for show_hidden (or use the default value), then get_locals skips over any local variables who\u2019s name starts with the dollar sign.<\/p>\n<p>Even if you pass in True for show_hidden, get_locals still skips over any variable named \u201c$site\u201d. $site variables are <a href=\"http:\/\/msdn.microsoft.com\/en-us\/magazine\/cc163344.aspx#S7\">dynamic call site caches<\/a>, a DLR feature that are used to efficiently dispatch dynamic calls by caching the results of previous invocations. Martin Maly\u2019s blog <a href=\"http:\/\/blogs.msdn.com\/mmaly\/archive\/2008\/04\/22\/dlr-caches.aspx\">has more details<\/a> on these caches. As they are part of method dispatch, I never want to show them to the ipydbg user, so they get skipped regardless of the value of show_hidden.<\/p>\n<p>Now that I can get the local variables for a given frame, we need to convert those variables to something you can print on the screen. That turns out to be more complicated that you might expect, so it\u2019ll have to wait for the next post (which may be a while, given that <a href=\"http:\/\/devhawk.net\/2009\/03\/11\/IronPython+At+PyCon.aspx\">PyCon<\/a> is this weekend). In the meantime, you can get the <a href=\"http:\/\/github.com\/devhawk\/ipydbg\/tree\/442527b0aed3ac2f7ecf6ab8f5f7e93ad03090f2\">latest version of ipydbg<\/a> from GitHub.<\/p>\n","excerpt":"<p>I just pushed out a new drop of ipydbg that includes the first cut of support for showing local variables. Getting the value for a local variable is actually pretty simple. The CorFrame object (which hangs off active_thread) includes a method to get a local variable by index as well getting a count of all [&hellip;]<\/p>\n","date":"2009-03-25 16:27:51","modified":"2009-03-25 16:27:51","categories":[{"id":252,"slug":"ironpython","title":"IronPython","description":"","parent":0,"post_count":99}],"tags":[{"id":279,"slug":"debugger","title":"Debugger","description":"","post_count":23}],"author":{"id":1,"slug":"admin","name":"DevHawk","first_name":"Harry","last_name":"Pierson","nickname":"DevHawk","url":"","description":""},"comments":[{"id":2186,"name":"Steve Shaw","url":"http:\/\/toolmakersteve.com","date":"2009-04-11 23:39:13","content":"<p>Re: &#8220;Getting the value for a local variable is actually pretty simple.&#8221;<\/p>\n<p>I&#8217;m glad SOMEONE finds this stuff simple  8D<\/p>\n<p>I&#8217;m even more glad I didn&#8217;t try learning how to do this a month ago, before you wrote this post!<\/p>\n<p>Thanks again,<br \/>\nSteve<\/p>\n","parent":0}],"attachments":[],"comment_count":1,"comment_status":"closed","custom_fields":{"dasblog_entryid":["c693512a-3698-478f-a95e-20d1be919b67"],"dasblog_compressedtitle":["Writing+An+IronPython+Debugger+Getting+Local+Variables"],"dasblog_compressedtitleunique":["2009\/03\/25\/Writing+An+IronPython+Debugger+Getting+Local+Variables"]}},"previous_url":"http:\/\/devhawk.net\/2009\/03\/24\/agdlr-0-5\/","next_url":"http:\/\/devhawk.net\/2009\/03\/27\/ironpython-2-6-alpha-1\/"}