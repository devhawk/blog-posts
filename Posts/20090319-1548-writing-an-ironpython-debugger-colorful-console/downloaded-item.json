{"status":"ok","post":{"id":1232,"type":"post","slug":"writing-an-ironpython-debugger-colorful-console","url":"http:\/\/devhawk.net\/2009\/03\/19\/writing-an-ironpython-debugger-colorful-console\/","status":"publish","title":"Writing an IronPython Debugger: Colorful Console","title_plain":"Writing an IronPython Debugger: Colorful Console","content":"<p>Now that I\u2019ve added the <a href=\"http:\/\/devhawk.net\/2009\/03\/19\/Writing+An+IronPython+Debugger+Showing+Source+Code.aspx\">current source code line<\/a> to the console output, I wanted to start using color in order to make it clearer to understand the various pieces of data that gets output. Now, the various event handler messages get output in dark grey while the current line of source is in yellow. Here\u2019s what it looks like on my machine (note, the top line with the green [11] is PowerShell and ipy2 is a PowerShell alias to ipy.exe v2.0.1)<\/p>\n<p><a href=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/WritinganIronPythonDebuggerColorfulConso_D87F\/image_4.png\" class=\"grouped_elements\" rel=\"tc-fancybox-group1232\"><img style=\"display: block; float: none; margin-left: auto; margin-right: auto; border-width: 0px;\" title=\"ipydbg on the console\" src=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/WritinganIronPythonDebuggerColorfulConso_D87F\/image_thumb_1.png\" border=\"0\" alt=\"ipydbg on the console\" width=\"684\" height=\"251\" \/><\/a><\/p>\n<p>Writing color to the windows console is a hassle because of the <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/system.console.foregroundcolor.aspx\">stateful API<\/a> it uses. The problem is that I always want to return to the default color after I\u2019ve written out a line of colored text. I wish there was an overload of Console.Write and WriteLine that took the foreground and background colors as arguments.<\/p>\n<p>Of course, I could easily implement my own write and writeline methods that took color parameters. However, I was loath to do that as Python\u2019s print statement is so convenient. So instead, I build a console color <a href=\"http:\/\/docs.python.org\/reference\/datamodel.html#context-managers\">context manager<\/a>. I got the idea from Luis Fallas\u2019 <a href=\"http:\/\/langexplr.blogspot.com\/2009\/02\/writing-xml-with-ironpython-xmlwriter.html\">XmlWriter context manager<\/a>.<\/p>\n<pre class=\"brush: python\">class ConsoleColorMgr(object):  \r\n  def __init__(self, color):  \r\n    self.color = color  \r\n\r\n  def __enter__(self):  \r\n    self.temp = Console.ForegroundColor  \r\n    Console.ForegroundColor = self.color  \r\n\r\n  def __exit__(self, t, v, tr):  \r\n    Console.ForegroundColor = self.temp  \r\n\r\nCCDarkGray = ConsoleColorMgr(ConsoleColor.DarkGray)     \r\nCCGray     = ConsoleColorMgr(ConsoleColor.Gray)     \r\nCCYellow   = ConsoleColorMgr(ConsoleColor.Yellow)\r\n\r\ndef OnCreateAppDomain(self, sender,e):  \r\n    with CCDarkGray:  \r\n      print \"OnCreateAppDomain\", e.AppDomain.Name  \r\n    e.AppDomain.Attach()<\/pre>\n<p>Python\u2019s <a href=\"http:\/\/docs.python.org\/reference\/compound_stmts.html#the-with-statement\">with statement<\/a> is similar to C#\u2019s <a href=\"http:\/\/msdn.microsoft.com\/en-us\/library\/yh598w02.aspx\">using statement<\/a>. However, unlike IDisposable object, Python context managers support both an enter and exit method. This means I don\u2019t have to construct an object in order to get a context (in this case, the console colors) managed. So far, I\u2019ve got three console color context managers defined \u2013 Grey, DarkGrey and Yellow. I\u2019m thinking that ConsoleColorMgr is a candidate for my <a href=\"http:\/\/github.com\/devhawk\/devhawk_ipy\/tree\/master\">assorted module collection<\/a> at some point.<\/p>\n<p>Now that I can print in color, I wanted to modify my <a href=\"http:\/\/devhawk.net\/2009\/03\/19\/Writing+An+IronPython+Debugger+Showing+Source+Code.aspx\">line printer<\/a> to use color. Usually, the current sequence point corresponds to an entire line of python source. But as we see below, sometimes only part of a given line of source text is associated with a given sequence point.<\/p>\n<p><a href=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/WritinganIronPythonDebuggerColorfulConso_D87F\/image_6.png\" class=\"grouped_elements\" rel=\"tc-fancybox-group1232\"><img style=\"display: block; float: none; margin-left: auto; margin-right: auto; border-width: 0px;\" title=\"image\" src=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/WritinganIronPythonDebuggerColorfulConso_D87F\/image_thumb_2.png\" border=\"0\" alt=\"image\" width=\"684\" height=\"115\" \/><\/a><\/p>\n<p>The other issue I ran into is that there\u2019s a always a sequence point at the very end of a function. Unlike the break at the start of the function I wrote about in my last post, this one I didn\u2019t want to automatically step over. This is the last breakpoint for a given scope, so I should give the user one last chance to inspect the scope (once I add the ability to do that, at any rate) before we step out of it. However, I wanted a way of showing that we\u2019re about to step out in the source code line view. I decided on writing a series of carets ^^^ to indicate that we\u2019re at the end of a function.<\/p>\n<p><a href=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/WritinganIronPythonDebuggerColorfulConso_D87F\/image_8.png\" class=\"grouped_elements\" rel=\"tc-fancybox-group1232\"><img style=\"display: block; float: none; margin-left: auto; margin-right: auto; border-width: 0px;\" title=\"image\" src=\"http:\/\/s3.amazonaws.com\/devhawk_images\/WindowsLiveWriter\/WritinganIronPythonDebuggerColorfulConso_D87F\/image_thumb_3.png\" border=\"0\" alt=\"image\" width=\"684\" height=\"60\" \/><\/a><\/p>\n<p>As you can see in the dark grey line in the screenshot above, the current sequence point starts and ends at line 4 column 23. Column 23 is beyond the end of line 4, so that\u2019s what I look for in order to draw the three carets. Here\u2019s the final version of _print_source_line:<\/p>\n<pre class=\"brush: python\">def _print_source_line(self, sp, lines):     \r\n  line = lines[sp.start_line-1]     \r\n  with CCGray:     \r\n    Console.Write(\"%d: \" % sp.start_line)     \r\n    Console.Write(line.Substring(0, sp.start_col-1))     \r\n    with CCYellow:     \r\n      if sp.start_col &gt; len(line):     \r\n        Console.Write(\" ^^^\")     \r\n      else:     \r\n        Console.Write(line.Substring(sp.start_col-1,     \r\n                                     sp.end_col - sp.start_col))     \r\n    Console.WriteLine(line.Substring(sp.end_col-1))<\/pre>\n<p>So colorizing the current line of source code turned out to be a little harder than I had expected. But hey, I got a start of a reusable module out of it. That\u2019s pretty cool. Anyway, the <a href=\"http:\/\/github.com\/devhawk\/ipydbg\/tree\/ec6520e32cf3214ade646696a0d52448754daf07\">latest bits<\/a> are, as always, up on GitHub.<\/p>\n","excerpt":"<p>Now that I\u2019ve added the current source code line to the console output, I wanted to start using color in order to make it clearer to understand the various pieces of data that gets output. Now, the various event handler messages get output in dark grey while the current line of source is in yellow. [&hellip;]<\/p>\n","date":"2009-03-19 15:48:43","modified":"2011-04-17 07:12:12","categories":[{"id":252,"slug":"ironpython","title":"IronPython","description":"","parent":0,"post_count":99}],"tags":[{"id":279,"slug":"debugger","title":"Debugger","description":"","post_count":23}],"author":{"id":1,"slug":"admin","name":"DevHawk","first_name":"Harry","last_name":"Pierson","nickname":"DevHawk","url":"","description":""},"comments":[],"attachments":[],"comment_count":0,"comment_status":"closed","custom_fields":{"dasblog_entryid":["7a543ffb-0771-4124-9d94-08a29bb588ea"],"dasblog_compressedtitle":["Writing+An+IronPython+Debugger+Colorful+Console"],"dasblog_compressedtitleunique":["2009\/03\/19\/Writing+An+IronPython+Debugger+Colorful+Console"]}},"previous_url":"http:\/\/devhawk.net\/2009\/03\/19\/writing-an-ironpython-debugger-showing-source-code\/","next_url":"http:\/\/devhawk.net\/2009\/03\/19\/ironpython-consolecolormgr\/"}