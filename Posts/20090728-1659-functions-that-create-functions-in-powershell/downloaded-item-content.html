<p>Since I started using Powershell, I&#8217;m very picky about what I let on my path. I feel it&#8217;s much cleaner to create aliases or functions rather than letting all kinds of crud creep into my path.</p>
<p>Recently, I installed the latest <a href="http://www.ironruby.com/Download">IronRuby release</a> and discovered there&#8217;s a whole bunch of little batch file wrappers around common Ruby commands like gem and rake. While being able to simply type &#8220;igem&#8221; or &#8220;irake&#8221; is much easier than typing &#8220;ir &#8220;C:Program Filesironruby-0.6.0binigem&#8221;&#8221;, I didn&#8217;t want to pollute my path &#8211; even with a product from my team. Instead, I wanted to create a Powershell function for each of those IronRuby-fied commands. Furthermore, I wanted to avoid manually creating a function for each Ruby command &#8211; these batchfiles are literally identical except for their name, so I figured it would be possible automate the function creation in Powershell. Here&#8217;s what I came up with:</p>
<pre class="brush: powershell">$iralias = get-alias ir -EA SilentlyContinue
if ($iralias -eq $null) {return}

$irbindir = split-path $iralias.Definition

function make-rubyfunction($cmd)
{
  $cmdpath = join-path $irbindir $cmd
  set-item function:global:$cmd -Value {ir $cmdpath $args}.GetNewClosure()
  write-host &quot;Added IronRuby $_ command&quot;
}

(&quot;igem&quot;,&quot;iirb&quot;,&quot;irackup&quot;,&quot;irails&quot;,&quot;irake&quot;,&quot;irdoc&quot;,&quot;iri&quot;) |
  %{make-rubyfunction $_}</pre>
<p>I start by getting the ir alias, which I&#8217;m <a href="http://devhawk.net/2008/12/17/PowerShell+Findtosetalias.aspx">setting in my traditional fashion</a>. The Ruby command files are in the same directory as ir.exe, which is what ir is aliased to. If the ir alias isn&#8217;t set, I quit out of the script without setting anything.</p>
<p>The make-rubyfunction function is the primary workhorse of this script. You pass in a command name as a string, and it uses <a href="http://technet.microsoft.com/en-us/library/dd347590.aspx">set-item</a> on the <a href="http://technet.microsoft.com/en-us/library/dd347741.aspx">function provider</a> to create a new function. Note, I had to explicitly create this function in the global scope since I&#8217;m running the set-item cmdlet inside a script.</p>
<p>Getting the value for the function took a bit of head banging to figure out. I&#8217;m used to Python, which automatically closes over variables, so my first attempt was to set the function value to something like { ir $cmdpath $args }. But Powershell doesn&#8217;t close automatically, so that fails since $cmd isn&#8217;t defined inside the function. I asked around on the internal Powershell alias, and someone pointed me to the new <a href="http://blogs.msdn.com/powershell/archive/2009/03/27/get-closure-with-getnewclosure.aspx">GetNewClosure</a> function in Powershell v2. In other words, Powershell only supports manual closures, which is kind of wonky, but works OK for this scenario. I create a new script block that references in-scope variable $cmdpath and GetNewClosure automatically creates a new script block where that value is captured and embedded. More info on GetNewClosure <a href="http://msdn.microsoft.com/en-us/library/system.management.automation.scriptblock.getnewclosure(VS.85).aspx">in the docs</a>.</p>
<p>Now, I&#8217;m using Win7 exclusively at this point, so depending on a v2 feature didn&#8217;t bother me. However, if you&#8217;re using Powershell v1, you could still accomplish something similar using text substitution. Here&#8217;s my original (i.e. pre-GetNewClosure) version of make-rubyfunction</p>
<pre class="brush: powershell">function make-rubyfunction($cmd)
{
  $cmdpath = join-path $irbindir $cmd
  $p = &quot;ir `&quot;$cmdpath`&quot; `$args&quot;
  set-item function:global:$cmd -Value $p
  write-host &quot;Added IronRuby $_ command&quot;
}</pre>
<p>I&#8217;m using Powershell&#8217;s standard text substitution mechanism to create the function value as a string. Note that I&#8217;m escaping the dollar sign in $args, so that does not get substituted the way $cmdpath does. GetNewClosure feels cleaner, so that&#8217;s how I ended up doing it, but both ways seem to work fine.</p>
<p>Finally, I pass an array of IronRuby commands down the pipe to make-rubyfunction. I love the pipe command, though it feels strange to use parentheses instead of square brackets for list comprehensions like Python and F#!</p>
<p>Anyway, the script &#8211; as usual &#8211; is <a href="http://cid-0d9bc809858885a4.skydrive.live.com/self.aspx/DevHawk%20Content/Powershell/ironruby%7C_aliases.ps1">up on my SkyDrive</a>. At some point, I want to do something similar for common IronPython scripts like <a href="http://ironpython.codeplex.com/SourceControl/changeset/view/57298#758946">pyc</a> and <a href="http://github.com/devhawk/ipydbg/tree/master">ipydbg</a>. Until then, hopefully someone out there will find it useful (like maybe the IronRuby team?).</p>
