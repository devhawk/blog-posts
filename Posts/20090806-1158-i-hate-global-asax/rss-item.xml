<?xml version="1.0" encoding="utf-8"?>
<item>
  <title>I Hate Global.asax</title>
  <link>http://devhawk.net/2009/08/06/i-hate-global-asax/</link>
  <pubDate>Thu, 06 Aug 2009 11:58:58 +0000</pubDate>
  <dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">devhawk</dc:creator>
  <guid isPermaLink="false">http://f8806ba3-a1bb-4c6f-8a39-a0ca8a81ef58</guid>
  <description></description>
  <content:encoded xmlns:content="http://purl.org/rss/1.0/modules/content/"><![CDATA[<p>One of the things I’ve always loved about ASP.NET is how easily extensible it is. Back in 2000, I had a customer that wanted to “skin” their website using XML and XSLT – an approach Martin Fowler later called <a href="http://martinfowler.com/eaaCatalog/transformView.html">Transform View</a>. We were working with classic ASP at the time, so the solution we ended up with was kind of ugly. But I was able to implement this approach in ASP.NET in a few hundred lines of code, which I wrote up in <a href="http://msdn.microsoft.com/en-us/magazine/dvdarchive/cc164164.aspx">an MSDN article</a> published back in 2003. In the conclusion of that article, I wrote the following:</p><blockquote><p>Using ASP.NET is kind of like having your mind read. If you ever look at a site and think "I need something different," you'll most likely find that the ASP.NET architects have considered that need and provided a mechanism for you to hook in your custom functionality. In this case, I've bypassed the built-in Web Forms and Web Services support to build an entire engine that services Web requests in a unique way.</p></blockquote><p>Nearly ten years later, I finally ran into a situation where ASP.NET failed to read my mind and doesn’t provide a mechanism to hook in custom functionality: Global.asax.</p><p>I always thought of global.asax as an obsolete construct primarily intended to ease migration from classic ASP. After all, ASP.NET has first class support for customizing request handling at various points throughout the execution pipeline via <a href="http://msdn.microsoft.com/en-us/library/system.web.ihttpmodule.aspx">IHttpModule</a>. Handling those events in global.asax always felt vaguely hacky to me. </p><p>However, what I didn’t realize is that there are some events that can only be handled via global.asax (or its code behind). In particular, Application_Start/End and Session_Start/End can only be handled in global.asax. Worse, these aren’t true events. For reasons I’m sure made sense at the time but that I don’t understand, the HttpApplicationFactory discovers these methods via reflection rather than by an interface or other more typical mechanism. You can check it out for yourself with <a href="http://reflector.red-gate.com">Reflector</a> or the <a href="http://referencesource.microsoft.com/">Reference Source</a> – look for the method with the wonderful name ReflectOnMethodInfoIfItLooksLikeEventHandler. No, I’m not making that up.</p><p>The reason I suddenly care about global.asax is because Application_Start is where ASP.NET MVC apps configure their route table. But if you want to access the Application_Start method in a dynamic language like IronPython, you’re pretty much out of luck. The only way to receive the Application_Start pseudo-event is via a custom HttpApplication class. But you can’t implement your custom HttpApplication in a dynamically typed language like IronPython since it finds the Application_Start method via Reflection. Ugh.</p><p>If someone can explain to me why ASP.NET uses reflection to fire the Application_Start event, I’d love to understand why it works this way. Even better - I’d love to see this fixed in some future version of ASP.NET. You come the only way to configure a custom HttpApplication class is to specify it via global.asax? Wouldn’t it make sense to specify it in web.config instead?</p><p>In order to support Application_Start for dynamic languages you basically have two choices:</p><ol><li>Build a custom HttpApplication class in C# and reference it in global.asax. This is kind of the approach used by Jimmy’s ironrubymvc project. He’s got a <a href="http://github.com/jschementi/ironrubymvc/blob/939319febe205a43d6837e50fe3fe4740708fd58/IronRubyMvc/Core/RubyMvcApplication.cs">RubyMvcApplication</a> which he inherits his <a href="http://github.com/jschementi/ironrubymvc/blob/939319febe205a43d6837e50fe3fe4740708fd58/IronRubyMvcWeb/Global.asax.cs">GlobalApplication</a> from. Given that GlobalApplication is empty, I think he could remove his global.asax.cs file and just reference RubyMvcApplication from global.asax directly. </li><li>Build custom Application_Start/End-like events out of IHttpModule Init and Dispose. You can have multiple IHttpModule instances in a given web app, so you’d need to make sure you ran fired Start and End only once. This is the approach taken by the <a href="http://aspnet.codeplex.com/Wiki/View.aspx?title=Dynamic%20Language%20Support">ASP.NET Dynamic Language Support</a>. [1] </li></ol><p>So here’s the question Iron Language Fans: Which of these approaches is better? I lean towards Option #1, since it traps exactly the correct event though it does require a global.asax file to be hanging around (kind of like how the ASP.NET MVC template has a blank default.aspx file “to ensure that ASP.NET MVC is activated by IIS when a user makes a "/" request”). But I’m curious what the Iron Language Community at large thinks. Feel free to leave me a comment or <a href="mailto:harry.pierson@microsoft.com">drop me an email</a> with your thoughts.</p><hr /><p>[1] FYI, I’m working on getting the code for ASP.NET Dynamic Language Support released. In the meantime, you can verify what I’m saying via Reflector.</p>]]></content:encoded>
  <excerpt:encoded xmlns:excerpt="http://wordpress.org/export/1.2/excerpt/"><![CDATA[]]></excerpt:encoded>
  <wp:post_id xmlns:wp="http://wordpress.org/export/1.2/">1276</wp:post_id>
  <wp:post_date xmlns:wp="http://wordpress.org/export/1.2/">2009-08-06 11:58:58</wp:post_date>
  <wp:post_date_gmt xmlns:wp="http://wordpress.org/export/1.2/">2009-08-06 11:58:58</wp:post_date_gmt>
  <wp:comment_status xmlns:wp="http://wordpress.org/export/1.2/">open</wp:comment_status>
  <wp:ping_status xmlns:wp="http://wordpress.org/export/1.2/">open</wp:ping_status>
  <wp:post_name xmlns:wp="http://wordpress.org/export/1.2/">i-hate-global-asax</wp:post_name>
  <wp:status xmlns:wp="http://wordpress.org/export/1.2/">publish</wp:status>
  <wp:post_parent xmlns:wp="http://wordpress.org/export/1.2/">0</wp:post_parent>
  <wp:menu_order xmlns:wp="http://wordpress.org/export/1.2/">0</wp:menu_order>
  <wp:post_type xmlns:wp="http://wordpress.org/export/1.2/">post</wp:post_type>
  <wp:post_password xmlns:wp="http://wordpress.org/export/1.2/"></wp:post_password>
  <wp:is_sticky xmlns:wp="http://wordpress.org/export/1.2/">0</wp:is_sticky>
  <category domain="post_tag" nicename="asp-net"><![CDATA[ASP.NET]]></category>
  <category domain="category" nicename="ironpython"><![CDATA[IronPython]]></category>
  <category domain="post_tag" nicename="ironruby"><![CDATA[IronRuby]]></category>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>dasblog_entryid</wp:meta_key>
    <wp:meta_value><![CDATA[f8806ba3-a1bb-4c6f-8a39-a0ca8a81ef58]]></wp:meta_value>
  </wp:postmeta>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>dasblog_compressedtitle</wp:meta_key>
    <wp:meta_value><![CDATA[I+Hate+Globalasax]]></wp:meta_value>
  </wp:postmeta>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>dasblog_compressedtitleunique</wp:meta_key>
    <wp:meta_value><![CDATA[2009/08/06/I+Hate+Globalasax]]></wp:meta_value>
  </wp:postmeta>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>2245</wp:comment_id>
    <wp:comment_author><![CDATA[Parag Mehta]]></wp:comment_author>
    <wp:comment_author_email>contact@jpinfoworld.com</wp:comment_author_email>
    <wp:comment_author_url>http://www.jpinfoworld.com</wp:comment_author_url>
    <wp:comment_author_IP>121.247.165.141</wp:comment_author_IP>
    <wp:comment_date>2009-08-09 22:02:00</wp:comment_date>
    <wp:comment_date_gmt>2009-08-10 05:02:00</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[That's a really interesting find :) I didn't realize this since I didn't use Dynamic language as yet.]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>2246</wp:comment_id>
    <wp:comment_author><![CDATA[Sea Cat]]></wp:comment_author>
    <wp:comment_author_email></wp:comment_author_email>
    <wp:comment_author_url></wp:comment_author_url>
    <wp:comment_author_IP>64.126.25.123</wp:comment_author_IP>
    <wp:comment_date>2009-08-10 09:16:37</wp:comment_date>
    <wp:comment_date_gmt>2009-08-10 16:16:37</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[What I don't understand is why you would want to use dynamic languages for asp.net development in the first place. Sounds like a bastardization of the environment to me.]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>2247</wp:comment_id>
    <wp:comment_author><![CDATA[Joe Chung]]></wp:comment_author>
    <wp:comment_author_email>joechung2008@gmail.com</wp:comment_author_email>
    <wp:comment_author_url></wp:comment_author_url>
    <wp:comment_author_IP>97.113.6.29</wp:comment_author_IP>
    <wp:comment_date>2009-08-22 13:04:08</wp:comment_date>
    <wp:comment_date_gmt>2009-08-22 20:04:08</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[The reason Application_Start, Application_End, Session_Start, and Session_End are like that is because of legacy.  ASP worked like that - http://msdn.microsoft.com/en-us/library/ms525965.aspx

Would it be possible to the route table in an  HttpApplication's Init method override instead?  Or is that too soon in the application's lifecycle to muck around with the ASP.NET routing table?]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>2248</wp:comment_id>
    <wp:comment_author><![CDATA[Michael Foord]]></wp:comment_author>
    <wp:comment_author_email>fuzzyman@voidspace.org.uk</wp:comment_author_email>
    <wp:comment_author_url>http://htto://www.ironpythoninaction.com</wp:comment_author_url>
    <wp:comment_author_IP>87.194.212.65</wp:comment_author_IP>
    <wp:comment_date>2009-08-23 14:34:43</wp:comment_date>
    <wp:comment_date_gmt>2009-08-23 21:34:43</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[@Sea cat
Once you done *anything* in a dynamic language you tend to want to use them wherever possible... ;-)]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>2249</wp:comment_id>
    <wp:comment_author><![CDATA[Dody Gunawinata]]></wp:comment_author>
    <wp:comment_author_email>dody@nomadlife.org</wp:comment_author_email>
    <wp:comment_author_url></wp:comment_author_url>
    <wp:comment_author_IP>41.237.157.155</wp:comment_author_IP>
    <wp:comment_date>2009-08-26 14:08:36</wp:comment_date>
    <wp:comment_date_gmt>2009-08-26 21:08:36</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[1st approach. It seems to be it's more straightforward. ]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>2250</wp:comment_id>
    <wp:comment_author><![CDATA[DevHawk]]></wp:comment_author>
    <wp:comment_author_email>harry@devhawk.net</wp:comment_author_email>
    <wp:comment_author_url></wp:comment_author_url>
    <wp:comment_author_IP>71.231.42.80</wp:comment_author_IP>
    <wp:comment_date>2009-08-26 23:14:26</wp:comment_date>
    <wp:comment_date_gmt>2009-08-27 06:14:26</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[@Dody, I was leaning that way as well.

@Joe, I don't see why you couldn't setup the route table in HttpApplication::Init. And since Init is virtual, that would solve the App_Start reflection problem. However, I'm not sure how to inject IronPython into the ASP.NET pipeline that early or how to configure an HttpApplication subclass without using global.asax. I'll ask around with my friends on the ASP.NET team though. Thanks for the suggestion!]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
</item>