<?xml version="1.0" encoding="utf-8"?>
<item>
  <title>Thoughts on C# Fluent Interfaces</title>
  <link>http://devhawk.net/2007/07/12/thoughts-on-c-fluent-interfaces/</link>
  <pubDate>Thu, 12 Jul 2007 14:38:19 +0000</pubDate>
  <dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">devhawk</dc:creator>
  <guid isPermaLink="false">http://f55c7062-3698-4b55-8a27-218408aa5714</guid>
  <description></description>
  <content:encoded xmlns:content="http://purl.org/rss/1.0/modules/content/"><![CDATA[<p>Martin Fowler <a href="http://martinfowler.com/bliki/DslReadings.html">points to</a> a <a href="http://andersnoras.com/blogs/anoras/archive/2007/07/04/i-m-coming-down-with-a-serious-case-of-the-dsls.aspx">couple</a> of <a href="http://andersnoras.com/blogs/anoras/archive/2007/07/09/behind-the-scenes-of-the-planning-dsl.aspx">articles</a> by Anders Norås on building internal / embedded domain specific languages in C#. Anders has built a DSL for creating calendar events and tasks, like you might expect to do in Outlook. Here's an example:</p><pre class="brush: csharp">
ToDoComponent planningTask = 
   Plan.ToDo("Plan project X"). 
      StartingNow. 
      MustBeCompletedBy("2007.08.17"). 
      ClassifyAs("Public"); 
planningTask.Save(); 

EventComponent planningMeeting = 
   Plan.Event("Project planning meeting"). 
      RelatedTo(planningTask). 
      WithPriority(1). 
      At("Head office"). 
      OrganizedBy("jane@megacorp.com", "Jane Doe"). 
      StartingAt("12:00").Lasting(45).Minutes. 
      Attendants( 
         "peter@megacorp.com", 
         "paul@megacorp.com", 
         "mary@contractor.com").AreRequired. 
      Attendant("john@megacorp.com").IsOptional. 
      Resource("Projector").IsRequired. 
      ClassifyAs("Public"). 
      CategorizeAs("Businees", "Development"). 
      Recurring.Until(2008).EverySingle.Week.On(Day.Thursday). 
      Except.Each.Year.In(Month.July | Month.August); 
planningMeeting.SendInvitations();
</pre><p>It may not be as clean as a say a Ruby version might be, but even with all the parens and periods it's still pretty readable. Fowler calls this a <a href="http://www.martinfowler.com/bliki/FluentInterface.html">fluent interface</a>, a term I like better than "internal DSL". </p><p>Two things jumped out at me reading Anders' <a href="http://andersnoras.com/blogs/anoras/archive/2007/07/09/behind-the-scenes-of-the-planning-dsl.aspx">entry</a> on how he built this fluent interface. First, there's a lot of code to make this work. Anders didn't publish the code, but he did admit: </p><blockquote><p>"Believe me, there will be a lot of code when you're done. I'm almost there with this DSL, and at the time of writing it consists of 58 classes not including the API and tests."</p></blockquote><p>That's 58 classes just to implement the fluent interface, not counting the underlying EventComponent API. That's a lot of non-business logic code to write. How many projects are willing to invest that kind of time and effort to build a fluent interface? (I would guess "not many")</p><p>However, I bet there's a lot of template-izable code in Anders fluent interface. When he writes about keeping the language consistent by "creating branches within our grammar using different descriptor objects", I can help but think about parser development with <a href="http://en.wikipedia.org/wiki/YACC">YACC</a> and the like. These tools typically use a DSL like <a href="http://en.wikipedia.org/wiki/Backus-Naur_form">BNF</a>. Maybe we could build a DSL for building fluent interfaces?</p><p>Second, Anders makes a very interesting point about the structure of the fluent interface code:</p><blockquote><p>Writing DSLs is a little different from the regular object oriented programming style. You might have noticed that the Plan class has a verb for its name rather than the usual noun. This allows us to have a natural starting point for writing out the "sentence" explaining our intention.</p></blockquote><p>Where have you seen this verb based approach before? Powershell cmdlets.</p><blockquote><p>Windows PowerShell uses a verb-noun pair format for the names of cmdlets and their derived .NET classes. For example, the Get-Command cmdlet provided by Windows PowerShell is used to retrieve all commands registered in the Windows PowerShell shell. The verb part of the name identifies the action that the cmdlet performs. The noun part of the name identifies the entity on which the action is performed. <br />[<a href="http://msdn2.microsoft.com/en-us/library/ms714428.aspx">Cmdlet Verb Names</a>, MSDN Library]</p></blockquote><p>I've <a href="http://devhawk.net/2007/02/06/Perusing+Powershell+Part+1+GetSQLServer.aspx">written</a> about this aspect of PowerShell before: </p><blockquote><p>In OO, most of the focus is on objects, naturally. However, administrators (i.e. the target audience of PS) tend to be much more task or action focused than object focused. Most OO languages don't have actions as a first class citizens within the language. C# and Java don't even allow stand alone functions - they always have to be at least static members of a class.  </p><p>I'm fairly sure there are many reasons why strongly typed OO languages aren't popular among administrators. I'm not going to go down the static/dynamic typing rat hole here, but I would guess the object/action language tradeoff is almost as important as the typing tradeoff. What's nice about PowerShell is that while it has strong object support, it also has strong action support as well. In PS, actions are called Cmdlets. While I'm not a big fan of the name, having first class support for them in PS is one of the things I find most interesting.<br />[<a href="http://devhawk.net/2007/02/06/Perusing+Powershell+Part+1+GetSQLServer.aspx">Perusing Powershell Part 1: Get-SQLServer</a>, DevHawk]</p></blockquote><p>While there is no first-class support for verbs or actions in C#, it looks like Anders has essentially rolled his own. For example, his Plan.Event() method returns a new EventDescriptor object. Subsequent calls on this object (RelatedTo, WithPriority, OrganizedBy) change the internal state of this EventDescriptor object. When you reach the end of the chain of calls, EventDescriptor has an implicit EventComponent cast operator that creates a new EventComponent with all the data that's been collected along the chain by the EventDescriptor.</p><p>Again, I can help but think a significant amount of code in this approach can be generalized and the creation automated. Also, I wonder if any of the new C# 3.0 capabilities could be used to improve the implementation. For example, would <a href="http://weblogs.asp.net/scottgu/archive/2007/03/13/new-orcas-language-feature-extension-methods.aspx">Extension Methods</a> make it easier to build the fluent interface? Maybe / Maybe not. Regardless, Anders has given me a lot to noodle on.</p>]]></content:encoded>
  <excerpt:encoded xmlns:excerpt="http://wordpress.org/export/1.2/excerpt/"><![CDATA[]]></excerpt:encoded>
  <wp:post_id xmlns:wp="http://wordpress.org/export/1.2/">1004</wp:post_id>
  <wp:post_date xmlns:wp="http://wordpress.org/export/1.2/">2007-07-12 14:38:19</wp:post_date>
  <wp:post_date_gmt xmlns:wp="http://wordpress.org/export/1.2/">2007-07-12 14:38:19</wp:post_date_gmt>
  <wp:comment_status xmlns:wp="http://wordpress.org/export/1.2/">open</wp:comment_status>
  <wp:ping_status xmlns:wp="http://wordpress.org/export/1.2/">open</wp:ping_status>
  <wp:post_name xmlns:wp="http://wordpress.org/export/1.2/">thoughts-on-c-fluent-interfaces</wp:post_name>
  <wp:status xmlns:wp="http://wordpress.org/export/1.2/">publish</wp:status>
  <wp:post_parent xmlns:wp="http://wordpress.org/export/1.2/">0</wp:post_parent>
  <wp:menu_order xmlns:wp="http://wordpress.org/export/1.2/">0</wp:menu_order>
  <wp:post_type xmlns:wp="http://wordpress.org/export/1.2/">post</wp:post_type>
  <wp:post_password xmlns:wp="http://wordpress.org/export/1.2/"></wp:post_password>
  <wp:is_sticky xmlns:wp="http://wordpress.org/export/1.2/">0</wp:is_sticky>
  <category domain="category" nicename="development"><![CDATA[Development]]></category>
  <category domain="post_tag" nicename="domain-specific-languages"><![CDATA[Domain Specific Languages]]></category>
  <category domain="post_tag" nicename="powershell"><![CDATA[PowerShell]]></category>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>dasblog_entryid</wp:meta_key>
    <wp:meta_value><![CDATA[f55c7062-3698-4b55-8a27-218408aa5714]]></wp:meta_value>
  </wp:postmeta>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>dasblog_compressedtitle</wp:meta_key>
    <wp:meta_value><![CDATA[Thoughts+On+C+Fluent+Interfaces]]></wp:meta_value>
  </wp:postmeta>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>dasblog_compressedtitleunique</wp:meta_key>
    <wp:meta_value><![CDATA[2007/07/12/Thoughts+On+C+Fluent+Interfaces]]></wp:meta_value>
  </wp:postmeta>
</item>