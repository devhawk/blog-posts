<?xml version="1.0" encoding="utf-8"?>
<item>
  <title>Using WinRT from C# //build Demo </title>
  <link>http://devhawk.net/2011/09/15/using-winrt-from-csharp-build-demo/</link>
  <pubDate>Thu, 15 Sep 2011 16:39:30 +0000</pubDate>
  <dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">devhawk</dc:creator>
  <guid isPermaLink="false">http://devhawk.net/?p=1924</guid>
  <description></description>
  <content:encoded xmlns:content="http://purl.org/rss/1.0/modules/content/"><![CDATA[Yesterday at<a href="http://www.buildwindows.com/"> //build</a>, Jesse Kaplan and I delivered the <a href="http://channel9.msdn.com/Events/BUILD/BUILD2011/TOOL-531T">Using Windows Runtime from C# and Visual Basic</a> talk. In the talk, I demonstrated how natural and familiar it is to use WinRT from C# by building a simple Metro style app. This app  takes a picture with a webcam and implements the share charm contract in less than 15 lines of C# code.

Instead of making you try and read code off the recorded video stream that should be published soon, I've written this walkthru to explain exactly what I did in that demo. In addition, I've started from scratch (i.e. File-&gt;New Project) so that you can follow along at home if you wish.

First, you need to install the <a href="http://msdn.microsoft.com/en-us/windows/apps/br229516">Windows Developer Preview</a>. I recommend the x64 version with tools. Scott Hanselman has a <a href="http://www.hanselman.com/blog/GuideToInstallingAndBootingWindows8DeveloperPreviewOffAVHDVirtualHardDisk.aspx">great write up</a> on using boot to VHD to run the preview. (though I do disagree w/ his assessment of dual boot. I've been dual booting Win7 and Win8 on my laptop for months and it's never ended in tears or blood). Also, you're going to need a webcam in order to run the app yourself.

Once the Windows Developer Preview is up and running, run the Socialite app and login with your Facebook credentials. We're going to use Socialite to share the picture we take with the webcam. Giving it your credentials up front makes the demo run smoother!

Next, fire up VS11 (aka Microsoft Visual Studio 11 Express for Windows Developer Preview). Create a new project and select the Visual C# -&gt; Windows Metro Style -&gt; Application template.

Once the new project has been created, you should be looking at the MainPage.xaml file. Update the Grid element to contain a button and an image.
<pre class="brush:xml">&lt;Grid x:Name="LayoutRoot" Background="#FF0C0C0C"&gt;
    &lt;Button x:Name="ClickMe" Click="ClickMe_Click"&gt;Click Me&lt;/Button&gt;
    &lt;Image x:Name="Photo" Width="800" Height="600"
           HorizontalAlignment="Center" VerticalAlignment="Center"/&gt;
&lt;/Grid&gt;</pre>
Next, hover over the Click="ClickMe_Click" attribute of the button, right click and select "Navigate to Event Handler". VS11 will take you to MainPage.xaml.cs and automatically generate a skeleton event handler for you.

In my //build session, I demonstrated that VS11 can automatically resolve WinRT namespaces the same way that it resolves managed namespaces. But for the purposes of this blog post, it's easier if you just add the additional using statements we're going to need at the top of MainPage.xaml.cs now.
<pre class="brush:csharp">using Windows.Media.Capture;
using Windows.Storage;
using Windows.UI.Xaml.Media.Imaging;
using Windows.ApplicationModel.DataTransfer;
using Windows.Storage.Streams;</pre>
Now, we add the code for ClickMe_Click:
<pre class="brush:csharp">private async void ClickMe_Click(object sender, RoutedEventArgs e)
{
    var ui = new CameraCaptureUI();
    ui.PhotoSettings.CroppedAspectRatio = new Size(4, 3);

    var file = await ui.CaptureFileAsync(CameraCaptureUIMode.Photo);

    if (file != null)
    {
        var stream = await file.OpenAsync(FileAccessMode.Read);

        var bitmap = new BitmapImage();
        bitmap.SetSource(stream);
        Photo.Source = bitmap;
    }
}</pre>
A few things to note about this code:
<ul>
	<li>Even though it's using native WinRT libraries, the C# feels natural and familiar - as if you were calling into traditional managed libraries. We're newing up classes, we're passing in constructor parameters, we're using primitive numbers and enums, we're assigning properties, etc. That is very much by design.</li>
	<li>We're using a couple of async WinRT methods (CaptureFileAsync and OpenAsync). C# 5.0's new await keyword to make it extremely easy to write linear looking code that doesn't block on async operations.</li>
	<li>No P/Invoke or COM Interop attributes anywhere to be seen!</li>
</ul>
Finally, before we can run this code we need to declare our intent to use the webcam. Double click on the Package.appxmanifest file, click on the "Capabilites" tab, and then check the Webcam checkbox.

With the capability declared, now we can run the app. Hit F5 and VS11 will compile and deploy the Metro style app you just built. Click the button, acknowledge that you want to let the program use the webcam, take a pic, crop it, and there it is in your UI!

For the second part of the demo, I added share contract support. Here's how to do that.

First, we need to pull the stream variable into class instance scope so that we can access it in the share contract event handler. We do that by adding a private IRandomAccessStream variable named stream and removing the var declarations from the line where we call OpenAsync. The updated click event handler looks like this:
<pre class="brush:csharp">//here's the instance scope stream variable
IRandomAccessStream stream;

private async void ClickMe_Click(object sender, RoutedEventArgs e)
{
    var ui = new CameraCaptureUI();
    ui.PhotoSettings.CroppedAspectRatio = new Size(4, 3);

    var file = await ui.CaptureFileAsync(CameraCaptureUIMode.Photo);

    if (file != null)
    {
        //the only change from the code above was to remove
        //the var declaration from the following line
        stream = await file.OpenAsync(FileAccessMode.Read);

        var bitmap = new BitmapImage();
        bitmap.SetSource(stream);
        Photo.Source = bitmap;
    }
}</pre>
Next, we need to wire up the share event handler in the XAML page's constructor. That's a single line of code and VS11 intellisense writes most of  it for you
<pre class="brush:csharp">public MainPage()
{
    InitializeComponent();
    DataTransferManager.GetForCurrentView().DataRequested +=
        new TypedEventHandler&lt;DataTransferManager, DataRequestedEventArgs&gt;(MainPage_DataRequested);
}</pre>
If you've ever wired up an event handler in C# before with VS, you'll be familiar with the "Press TAB to insert" the correct event handler type followed by "TAB to generate handler". Even though hthis is a WinRT event, VS11 helps you wire it up just the same as it does for managed events.

Now we implement the share contract event handler. That's just a simple if statement - calling args.Request.Data.SetBitmap if the user has taken a picture and calling args.Request.FailWithDisplayText with an error message if they have not.
<pre class="brush:csharp">private void MainPage_DataRequested(DataTransferManager sender,
    DataRequestedEventArgs args)
{
    if (stream == null)
        args.Request.FailWithDisplayText("No picture taken!");
    else
        args.Request.Data.SetBitmap(stream);
}</pre>
This part of the demo shows off static methods and event handlers. Again, note how natural and familiar it feels to use WinRT from C#.

And we're done, so hit F5 to build, deploy and run the app again.

I didn't remember to do this in the //build talk, but first try selecting the share contract <em>before </em>taking a picture. Windows will display the "No picture taken" text in share contract window since the user taken a picture to share yet. That's pretty boring so dismiss the share contract and take a picture like you did before. Then select the share contract, select Socalite, write a pithy message and press "Share in Facebook".

That's the entire demo! Taking a picture with the webcam, uploading to facebook, calling native WinRT APIs from C# in a natural and familiar way and all in just under 15 lines of code!

With our talk and demos, Jesse and I wanted to communicate just how important C# and VB are in the overall developer story for Windows 8. This demo shows off the hard work our two teams have done in order to make sure the managed developer's experience with Windows 8 was the best that it could be. As I said in the talk - if you're a managed developer, <span style="text-decoration: underline;">you already know how to build these Metro style apps</span>.

I know I <a href="http://devhawk.net/2011/09/15/the-windows-runtime/">said it before</a>, but I really can't wait to see what you guys build with Windows 8!]]></content:encoded>
  <excerpt:encoded xmlns:excerpt="http://wordpress.org/export/1.2/excerpt/"><![CDATA[]]></excerpt:encoded>
  <wp:post_id xmlns:wp="http://wordpress.org/export/1.2/">1924</wp:post_id>
  <wp:post_date xmlns:wp="http://wordpress.org/export/1.2/">2011-09-15 09:39:30</wp:post_date>
  <wp:post_date_gmt xmlns:wp="http://wordpress.org/export/1.2/">2011-09-15 16:39:30</wp:post_date_gmt>
  <wp:comment_status xmlns:wp="http://wordpress.org/export/1.2/">open</wp:comment_status>
  <wp:ping_status xmlns:wp="http://wordpress.org/export/1.2/">open</wp:ping_status>
  <wp:post_name xmlns:wp="http://wordpress.org/export/1.2/">using-winrt-from-csharp-build-demo</wp:post_name>
  <wp:status xmlns:wp="http://wordpress.org/export/1.2/">publish</wp:status>
  <wp:post_parent xmlns:wp="http://wordpress.org/export/1.2/">0</wp:post_parent>
  <wp:menu_order xmlns:wp="http://wordpress.org/export/1.2/">0</wp:menu_order>
  <wp:post_type xmlns:wp="http://wordpress.org/export/1.2/">post</wp:post_type>
  <wp:post_password xmlns:wp="http://wordpress.org/export/1.2/"></wp:post_password>
  <wp:is_sticky xmlns:wp="http://wordpress.org/export/1.2/">0</wp:is_sticky>
  <category domain="post_tag" nicename="build"><![CDATA[//build]]></category>
  <category domain="post_tag" nicename="c-sharp"><![CDATA[C#]]></category>
  <category domain="category" nicename="development"><![CDATA[Development]]></category>
  <category domain="post_tag" nicename="metro-style-apps"><![CDATA[Metro style apps]]></category>
  <category domain="category" nicename="windows"><![CDATA[Windows]]></category>
  <category domain="post_tag" nicename="windows-8"><![CDATA[Windows 8]]></category>
  <category domain="category" nicename="windows-runtime"><![CDATA[Windows Runtime]]></category>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>_edit_last</wp:meta_key>
    <wp:meta_value><![CDATA[1]]></wp:meta_value>
  </wp:postmeta>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>3189</wp:comment_id>
    <wp:comment_author><![CDATA[Mike Smith]]></wp:comment_author>
    <wp:comment_author_email>Msmithy@gotchu.com</wp:comment_author_email>
    <wp:comment_author_url></wp:comment_author_url>
    <wp:comment_author_IP>188.29.103.241</wp:comment_author_IP>
    <wp:comment_date>2011-09-16 10:30:29</wp:comment_date>
    <wp:comment_date_gmt>2011-09-16 17:30:29</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[Well we won't be building enterprise apps in silverlight that's for sure! :-(]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>3190</wp:comment_id>
    <wp:comment_author><![CDATA[Volker Hetzer]]></wp:comment_author>
    <wp:comment_author_email>volker.hetzer@ts.fujitsu.com</wp:comment_author_email>
    <wp:comment_author_url></wp:comment_author_url>
    <wp:comment_author_IP>80.70.169.36</wp:comment_author_IP>
    <wp:comment_date>2011-09-19 09:49:43</wp:comment_date>
    <wp:comment_date_gmt>2011-09-19 16:49:43</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[Hi!
Great talk, even it I only saw the recording!
Only, I still have some problems understanding the plumbing behind the WinRT/CLR stuff:
Given, for example a WinRT call that returns a vector or a Map, what do I really get?
Like, will the CLR GC be able to move it around, like native .NET objects?
Will a
<code>
foreach (WinRTObject O in X.GetWinRTCollection())
{
dowomethingWith(O;)
}
</code>
involve COM interop and RTW stuff?
I've asked this in <a href="http://social.msdn.microsoft.com/forums/en-us/vblanguage/thread/04955BA7-C940-46EB-8F55-374600AE262C" / rel="nofollow"> but so far didn't get enlightened very much.

Very nice talk!
Volker]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>3191</wp:comment_id>
    <wp:comment_author><![CDATA[DevHawk]]></wp:comment_author>
    <wp:comment_author_email>harry@devhawk.net</wp:comment_author_email>
    <wp:comment_author_url></wp:comment_author_url>
    <wp:comment_author_IP>131.107.0.125</wp:comment_author_IP>
    <wp:comment_date>2011-09-19 13:56:10</wp:comment_date>
    <wp:comment_date_gmt>2011-09-19 20:56:10</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[Glad you liked the talk Volker! As I said in the talk, WinRT is built on a foundation of COM. So, yes, whenever you use WinRT from C#, you're using COM interop and RCWs (I'm assuming you meant "RCW" aka Runtime Callable Wrapper when you wrote "RTW stuff".)

As you might imagine, I took the weekend off, but I'll be surfing the forums regularly answering questions in the future.]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>3190</wp:comment_parent>
    <wp:comment_user_id>1</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>3192</wp:comment_id>
    <wp:comment_author><![CDATA[Josh Smith]]></wp:comment_author>
    <wp:comment_author_email>flapplejacks@gmail.com</wp:comment_author_email>
    <wp:comment_author_url>http://joshsmithonwpf.wordpress.com</wp:comment_author_url>
    <wp:comment_author_IP>66.235.47.69</wp:comment_author_IP>
    <wp:comment_date>2011-09-19 21:53:09</wp:comment_date>
    <wp:comment_date_gmt>2011-09-20 04:53:09</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[Thanks for the helpful write up. One thing...the demo doesn't unhook the DataRequested event of the DataTransferManager. Unless there are weak events being used in WinRT, this sample code probably causes a memory leak because the MainPage is always referenced by an instance of DataTransferManager (whose lifetime I assume is greater than that of the page). Or is there some new greatness in WinRT's eventing model that I'm not aware of?

Thanks,
Josh]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>3193</wp:comment_id>
    <wp:comment_author><![CDATA[Kevin C]]></wp:comment_author>
    <wp:comment_author_email>kevinc43@gmail.com</wp:comment_author_email>
    <wp:comment_author_url></wp:comment_author_url>
    <wp:comment_author_IP>95.150.230.153</wp:comment_author_IP>
    <wp:comment_date>2011-09-23 07:27:02</wp:comment_date>
    <wp:comment_date_gmt>2011-09-23 14:27:02</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[A quick couple of questions:
1) If an app is written in pure XAML - say a grid with a few boxes - with no code of any kind (c#/javascript/c++) - are any dotnet libs/runtime's loaded? Does XAML in Win8/Metro have any dotnet dependencies? Is the code that renders the declarative XAML

2) Can javascript project be written to work with XAML instead of HTML.]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
    <wp:commentmeta>
      <wp:meta_key>akismet_result</wp:meta_key>
      <wp:meta_value><![CDATA[false]]></wp:meta_value>
    </wp:commentmeta>
    <wp:commentmeta>
      <wp:meta_key>akismet_history</wp:meta_key>
      <wp:meta_value><![CDATA[a:4:{s:4:"time";s:15:"1316788022.8845";s:7:"message";s:28:"Akismet cleared this comment";s:5:"event";s:9:"check-ham";s:4:"user";s:0:"";}]]></wp:meta_value>
    </wp:commentmeta>
    <wp:commentmeta>
      <wp:meta_key>akismet_history</wp:meta_key>
      <wp:meta_value><![CDATA[a:4:{s:4:"time";s:15:"1316832947.2094";s:7:"message";s:46:"devhawk changed the comment status to approved";s:5:"event";s:15:"status-approved";s:4:"user";s:7:"devhawk";}]]></wp:meta_value>
    </wp:commentmeta>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>3194</wp:comment_id>
    <wp:comment_author><![CDATA[DevHawk]]></wp:comment_author>
    <wp:comment_author_email>harry@devhawk.net</wp:comment_author_email>
    <wp:comment_author_url></wp:comment_author_url>
    <wp:comment_author_IP>71.231.40.153</wp:comment_author_IP>
    <wp:comment_date>2011-09-23 19:57:56</wp:comment_date>
    <wp:comment_date_gmt>2011-09-24 02:57:56</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[1) I'm not sure how compelling a pure XAML app would be. But Windows XAML does not depend on .NET. If you build a Metro style app with XAML and C++, you don't load the CLR.

2) No, JS only works with HTML.]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>3193</wp:comment_parent>
    <wp:comment_user_id>1</wp:comment_user_id>
    <wp:commentmeta>
      <wp:meta_key>akismet_result</wp:meta_key>
      <wp:meta_value><![CDATA[false]]></wp:meta_value>
    </wp:commentmeta>
    <wp:commentmeta>
      <wp:meta_key>akismet_history</wp:meta_key>
      <wp:meta_value><![CDATA[a:4:{s:4:"time";s:15:"1316833076.5071";s:7:"message";s:28:"Akismet cleared this comment";s:5:"event";s:9:"check-ham";s:4:"user";s:7:"devhawk";}]]></wp:meta_value>
    </wp:commentmeta>
  </wp:comment>
</item>