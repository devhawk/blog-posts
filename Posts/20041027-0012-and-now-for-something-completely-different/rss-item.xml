<?xml version="1.0" encoding="utf-8"?>
<item>
  <title>And Now For Something Completely Different</title>
  <link>http://devhawk.net/2004/10/27/and-now-for-something-completely-different/</link>
  <pubDate>Wed, 27 Oct 2004 00:12:44 +0000</pubDate>
  <dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">devhawk</dc:creator>
  <guid isPermaLink="false">http://59d1b2b3-12f9-409b-a4cc-8c1dbbeeac8f</guid>
  <description></description>
  <content:encoded xmlns:content="http://purl.org/rss/1.0/modules/content/"><![CDATA[<p>We interupt this blog's coverage of OOPSLA with a quick observation &amp; question related to development...</p><p>I'm hacking around writing a Word 2003 SmartTag in C# (more on the why later). I wanted my <a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stobjISmartTagRecognizer2.asp">recognizer</a> to be document-dependent - i.e. depending on some custom document properties, I wanted to change what gets recognized. A little digging reveils that there is no way (that I could find) to access the Word object model from the recognizer! The <a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stmthRecognize.asp">Recognize</a> (and <a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stmthRecognize2.asp">Recognize2</a>) method receives strings as parameters, but it doesn't receive an app-specific target object. This is unlike the Smart Tag <a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stobjISmartTagAction.asp">Action</a>'s <a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stmthInvokeVerb.asp">InvokeVerb</a> (and <a href="http://msdn.microsoft.com/library/en-us/stagsdk/html/stmthInvokeVerb2.asp">InvokeVerb2</a>) method which receives a <a href="http://msdn.microsoft.com/library/en-us/vbawd11/html/woobjRange1.asp">Range object</a> (from which you can navigate to the containing document, application and window) when running inside of Word. Bummer.</p><p>I think the reason for this is that the recognizer appears to run on a background thread while the action appears to run on the main app thread. Furthermore, both threads are STA apartment threaded, so if I can access the COM-based object model from the action thread, I can't access it directly from the recognizer thread. I actually hacked up an add-in to provide the <a href="http://msdn.microsoft.com/library/en-us/vbawd11/html/woproActiveDocument1.asp">ActiveDocument</a> to the recognizer thru a backchannel and it hangs Word on shutdown. I thought there might be an issue releasing the COM reference, but explicitly releasing it crashes the recognizer the next time it accesses the ActiveDocument.</p><p>So I've come to the conclusion that I somehow need to marshal this call from the background thread to the main app thread the action and addin are runing on (I did verify that both of those run on the same thread). The question is, what's the best way to do that given that I'm writing this in C#? I thought I might use a system similar to Windows Form's <a href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfSystemWindowsFormsControlClassInvokeTopic.asp">Control.Invoke(...)</a>, but it turns out that works by sending windows messages which isn't particularly feasible for my problem. So now I'm thinking I have pass the ActiveDocument reference to the background thread using <a href="http://msdn.microsoft.com/library/en-us/com/htm/cmf_a2c_8205.asp">CoMarshalInterface</a>. Or I might be able to use <a href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfSystemRuntimeRemotingRemotingServicesClassMarshalTopic.asp">RemotingServices.Marshal()</a> instead.</p><p>Anyone have any ideas? If so, leave a comment or <a href="mailto:hpierson_at_microsoft_dot_com">drop me a line</a>.</p>]]></content:encoded>
  <excerpt:encoded xmlns:excerpt="http://wordpress.org/export/1.2/excerpt/"><![CDATA[]]></excerpt:encoded>
  <wp:post_id xmlns:wp="http://wordpress.org/export/1.2/">462</wp:post_id>
  <wp:post_date xmlns:wp="http://wordpress.org/export/1.2/">2004-10-27 00:12:44</wp:post_date>
  <wp:post_date_gmt xmlns:wp="http://wordpress.org/export/1.2/">2004-10-27 00:12:44</wp:post_date_gmt>
  <wp:comment_status xmlns:wp="http://wordpress.org/export/1.2/">open</wp:comment_status>
  <wp:ping_status xmlns:wp="http://wordpress.org/export/1.2/">open</wp:ping_status>
  <wp:post_name xmlns:wp="http://wordpress.org/export/1.2/">and-now-for-something-completely-different</wp:post_name>
  <wp:status xmlns:wp="http://wordpress.org/export/1.2/">publish</wp:status>
  <wp:post_parent xmlns:wp="http://wordpress.org/export/1.2/">0</wp:post_parent>
  <wp:menu_order xmlns:wp="http://wordpress.org/export/1.2/">0</wp:menu_order>
  <wp:post_type xmlns:wp="http://wordpress.org/export/1.2/">post</wp:post_type>
  <wp:post_password xmlns:wp="http://wordpress.org/export/1.2/"></wp:post_password>
  <wp:is_sticky xmlns:wp="http://wordpress.org/export/1.2/">0</wp:is_sticky>
  <category domain="category" nicename="development"><![CDATA[Development]]></category>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>dasblog_entryid</wp:meta_key>
    <wp:meta_value><![CDATA[59d1b2b3-12f9-409b-a4cc-8c1dbbeeac8f]]></wp:meta_value>
  </wp:postmeta>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>dasblog_compressedtitle</wp:meta_key>
    <wp:meta_value><![CDATA[And+Now+For+Something+Completely+Different]]></wp:meta_value>
  </wp:postmeta>
  <wp:postmeta xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:meta_key>dasblog_compressedtitleunique</wp:meta_key>
    <wp:meta_value><![CDATA[2004/10/27/And+Now+For+Something+Completely+Different]]></wp:meta_value>
  </wp:postmeta>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>2695</wp:comment_id>
    <wp:comment_author><![CDATA[Babu Annamalai]]></wp:comment_author>
    <wp:comment_author_email>babu.annamalai@capco.com</wp:comment_author_email>
    <wp:comment_author_url>http://dotnetjunkies.com/WebLog/BabuA</wp:comment_author_url>
    <wp:comment_author_IP></wp:comment_author_IP>
    <wp:comment_date>2004-10-27 08:53:14</wp:comment_date>
    <wp:comment_date_gmt>2004-10-27 15:53:14</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[Hi pierson,
If we want smart tags to be attached to a specific document template, we need to configure the expansion pack which we will be attaching to the document template. stating this, there will be a document template associated to a specific expansion pack manifest file.

We will be building the smart tag dll in the usual way, but you will need to use XML expansion pack and the XML expansion manifest file to deploy that smart tag.

Have a look at the XML Expansion pack schema, for configuring smart tag deployment, in Microsoft Office 2003 Smart document SDK.

Cheers,
Babu]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
  <wp:comment xmlns:wp="http://wordpress.org/export/1.2/">
    <wp:comment_id>2696</wp:comment_id>
    <wp:comment_author><![CDATA[Babu Annamalai]]></wp:comment_author>
    <wp:comment_author_email>babu.annamalai@capco.com</wp:comment_author_email>
    <wp:comment_author_url>http://dotnetjunkies.com/WebLog/BabuA</wp:comment_author_url>
    <wp:comment_author_IP></wp:comment_author_IP>
    <wp:comment_date>2004-10-27 09:01:00</wp:comment_date>
    <wp:comment_date_gmt>2004-10-27 16:01:00</wp:comment_date_gmt>
    <wp:comment_content><![CDATA[Hi Pierson,
Using custom properties is a tricky one, but we can add required data to registry using the expansion pack manifest file (schema already available to do this) and use that data in your smart tag. This can also be document specific, because you are doing this at a expansion pack level.

Cheers,
Babu]]></wp:comment_content>
    <wp:comment_approved>1</wp:comment_approved>
    <wp:comment_type></wp:comment_type>
    <wp:comment_parent>0</wp:comment_parent>
    <wp:comment_user_id>0</wp:comment_user_id>
  </wp:comment>
</item>